<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tijdregistratie</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f0f2f5;
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            max-width: 95vw;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            margin: 0;
            color: #1a1a1a;
            font-size: 2.4em;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .planning-upload-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-upload {
            background: #0063ac;
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.2s;
            min-height: 48px;
            box-shadow: 0 2px 8px rgba(0,99,172,0.3);
        }

        .btn-upload:hover {
            background: #004a85;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,99,172,0.4);
        }

        .file-name-display {
            color: #495057;
            font-size: 1.1em;
            font-weight: 600;
            padding: 12px 18px;
            background: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 8px;
            display: none;
        }

        #auth-buttons {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .date-selection-section {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #0063ac;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .date-selection-section h3 {
            color: #0063ac;
            font-size: 1.3em;
            font-weight: 600;
            margin: 0;
        }

        .current-week {
            font-weight: 600;
            color: #0063ac;
            font-size: 1.1em;
            text-align: center;
            min-width: 200px;
        }

        .day-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .day-btn {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 12px 18px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.2s;
            min-height: 50px;
            min-width: 120px;
            text-align: center;
        }

        .day-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .day-btn.selected {
            background: #fed500;
            color: #1a1a1a;
            border-color: #ffc107;
            box-shadow: 0 2px 8px rgba(254,213,0,0.4);
        }

        .day-btn.today {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .day-btn.today.selected {
            background: #fed500;
            color: #1a1a1a;
            border-color: #ffc107;
        }

        .day-btn.future {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .selected-date-display {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .section {
            margin-bottom: 30px;
            width: 100%;
        }

        .section h2 {
            color: #343a40;
            margin-bottom: 18px;
            font-size: 1.6em;
            font-weight: 600;
        }

        .btn-uniform {
            background: #6c757d;
            color: white;
            padding: 16px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.2s;
            min-height: 50px;
            min-width: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-uniform:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-uniform.btn-yellow {
            background: #fed500;
            color: #1a1a1a;
            box-shadow: 0 2px 8px rgba(254,213,0,0.3);
        }

        .btn-uniform.btn-yellow:hover {
            background: #e6c200;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(254,213,0,0.4);
        }

        .btn-auth {
            background: #fed500;
            color: #1a1a1a;
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.2s;
            min-height: 48px;
            box-shadow: 0 2px 8px rgba(254,213,0,0.3);
        }

        .btn-auth:hover {
            background: #e6c200;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(254,213,0,0.4);
        }

        .btn-auth.sign-out {
            background: #dc3545;
        }

        .btn-auth.sign-out:hover {
            background: #c82333;
        }

        .user-info {
            color: #333;
            font-size: 1.1em;
            margin-right: 20px;
            font-weight: 600;
            background: #f8f9fa;
            padding: 12px 18px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            white-space: nowrap;
        }

        .planning-section,
        .data-overview {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #dee2e6;
            width: 100%;
            box-sizing: border-box;
        }

        .planning-section h3,
        .data-overview h3 {
            margin-bottom: 20px;
            color: #495057;
            font-size: 1.4em;
            font-weight: 600;
        }

        .file-input {
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            font-size: 1em;
            min-width: 200px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-input:hover {
            border-color: #0063ac;
            background: #f8f9fa;
        }

        .file-input:focus {
            outline: none;
            border-color: #0063ac;
            box-shadow: 0 0 0 3px rgba(0,99,172,0.1);
        }

        .planning-filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .planning-filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .planning-filter-label {
            font-weight: 600;
            color: #495057;
            font-size: 1.1em;
            margin-bottom: 10px;
            display: block;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .filter-btn {
            background: #e9ecef;
            color: #495057;
            padding: 16px 24px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 600;
            transition: all 0.2s;
            min-height: 56px;
            white-space: nowrap;
        }

        .filter-btn:hover {
            background: #007bff;
            color: white;
            border-color: #0056b3;
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: #0063ac;
            color: white;
            border-color: #004a85;
            box-shadow: 0 2px 8px rgba(0,99,172,0.3);
        }

        .filter-btn.active:hover {
            background: #004a85;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,99,172,0.4);
        }

        .planning-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            font-size: 1.1em;
            border: 2px solid #dee2e6;
        }

        .planning-table th,
        .planning-table td {
            padding: 15px 12px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
        }

        .planning-table th {
            background: #0063ac;
            color: white;
            font-weight: 600;
            font-size: 1.2em;
        }

        .planning-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .planning-table tr:hover {
            background: #e9ecef;
        }

        .planning-table tr:last-child td {
            border-bottom: none;
        }

        .planning-table td:last-child,
        .planning-table th:last-child {
            border-right: none;
        }

        .planning-table th.werkelijk-header.status-empty {
            background: #dc3545 !important; /* Rood - nog niets ingevuld */
        }

        .planning-table th.werkelijk-header.status-partial {
            background: #ffc107 !important; /* Geel - alles ingevuld maar afwijkingen */
            color: #212529 !important;
        }

        .planning-table th.werkelijk-header.status-complete {
            background: #28a745 !important; /* Groen - alles correct */
        }

        .planning-table td.werkelijk-cell {
            font-weight: 600;
            color: white;
        }

        .planning-table td.werkelijk-cell.exact {
            background: #28a745;
            color: white;
        }

        .planning-table td.werkelijk-cell.close {
            background: #ffc107;
            color: #212529;
        }

        .planning-table td.werkelijk-cell.far {
            background: #dc3545;
            color: white;
        }

        .planning-table td.werkelijk-cell.empty {
            background: #f8f9fa;
            color: #6c757d;
            font-weight: normal;
        }

        .planning-table td.werkelijk-cell.pending {
            background: #0063ac;
            color: white;
            font-weight: 600;
        }

        .planning-table td.clickable-name-cell {
            cursor: pointer !important;
            transition: all 0.2s ease;
            position: relative;
            font-weight: 600 !important;
            color: #0063ac !important;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid transparent;
        }

        .planning-table td.clickable-name-cell:hover {
            background: linear-gradient(135deg, #007bff, #0056b3) !important;
            color: white !important;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
            border: 2px solid #004085;
            z-index: 10;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            width: 95%;
            max-width: 1200px;
            height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .hours-modal-content {
            max-width: 1400px;
            height: 90vh;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: #1a1a1a;
            font-size: 1.8em;
            font-weight: 600;
        }

        .btn-close {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.6em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-close:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .workline-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            background: #f8f9fa;
            width: 100%;
            box-sizing: border-box;
        }

        .workline-btn {
            padding: 24px 20px;
            background: #0063ac;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .workline-btn:hover {
            background: #004a85;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,99,172,0.3);
        }

        .workline-btn.selected {
            background: #fed500;
            color: #1a1a1a;
            box-shadow: 0 6px 25px rgba(254,213,0,0.4);
        }

        .workline-btn.has-hours {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .workline-btn.has-hours:hover {
            background: linear-gradient(135deg, #218838, #1ea085);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .workline-btn.has-hours.selected {
            background: linear-gradient(135deg, #fed500, #ffc107);
            color: #1a1a1a;
            box-shadow: 0 6px 25px rgba(254,213,0,0.5);
        }

        .workline-btn small {
            font-size: 0.8em;
            opacity: 0.9;
            font-weight: 500;
        }

        .employee-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 12px;
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            background: #f8f9fa;
            width: 100%;
            box-sizing: border-box;
        }

        .employee-btn {
            padding: 18px 12px;
            background: #0063ac;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .employee-btn:hover {
            background: #004a85;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,99,172,0.3);
        }

        .employee-btn.selected {
            background: #fed500;
            color: #1a1a1a;
            box-shadow: 0 4px 15px rgba(254,213,0,0.4);
            font-weight: 600;
        }

        .add-employee-row {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 30px;
        }

        .employee-input {
            flex: 1;
            padding: 18px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1.2em;
            min-height: 56px;
        }

        .employee-input:focus {
            outline: none;
            border-color: #0063ac;
            box-shadow: 0 0 0 3px rgba(0,99,172,0.1);
        }

        .btn-add {
            background: #0063ac;
            color: white;
            padding: 18px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 500;
            min-height: 56px;
            transition: all 0.2s;
        }

        .btn-add:hover {
            background: #004a85;
            transform: translateY(-1px);
        }

        .employee-list {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            background: white;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
        }

        .employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            font-size: 1.2em;
        }

        .employee-item:last-child {
            border-bottom: none;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 18px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            min-height: 40px;
            transition: all 0.2s;
        }

        .btn-remove:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .activities-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 25px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            overflow: hidden;
            background: white;
        }

        .activities-table th,
        .activities-table td {
            padding: 20px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            font-size: 1.3em;
        }

        .activities-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 1.4em;
        }

        .activities-table tr:hover {
            background: #f8f9fa;
        }

        .activities-table tr:last-child td {
            border-bottom: none;
        }

        .hour-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            justify-content: flex-start;
            width: 100%;
        }

        .hour-buttons-group {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .hour-btn {
            width: 75px;
            height: 65px;
            border: 2px solid #dee2e6;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        .hour-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            transform: translateY(-1px);
        }

        .hour-btn.minus {
            color: #dc3545;
            border-color: #dc3545;
        }

        .hour-btn.minus:hover {
            background: #dc3545;
            color: white;
        }

        .hour-btn.plus {
            color: #0063ac;
            border-color: #0063ac;
        }

        .hour-btn.plus:hover {
            background: #0063ac;
            color: white;
        }

        .hour-input {
            width: 105px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            text-align: center;
            font-size: 1.3em;
            font-weight: 600;
            background: #fff;
            min-height: 65px;
        }

        .hour-input:focus {
            outline: none;
            border-color: #0063ac;
            box-shadow: 0 0 0 3px rgba(0,99,172,0.1);
        }

        .controls {
            text-align: center;
            margin-top: 30px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 40px;
        }

        .btn {
            padding: 15px 35px;
            margin: 0 12px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 56px;
        }

        .btn-primary {
            background: #0063ac;
            color: white;
            padding: 22px 60px;
            font-size: 1.5em;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #004a85;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,99,172,0.3);
        }

        .btn-secondary {
            background: #f44336;
            color: white;
        }

        .btn-secondary:hover {
            background: #da190b;
            transform: translateY(-1px);
        }

        .btn-clear {
            background: #dc3545;
            color: white;
            padding: 10px 18px;
            font-size: 1em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 8px;
            min-height: 44px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-clear:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .btn-fullday {
            background: #FF9800;
            color: white;
            width: 75px;
            height: 65px;
            border: 2px solid #FF9800;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        .btn-fullday:hover {
            background: #F57C00;
            border-color: #F57C00;
            transform: translateY(-1px);
        }

        .hidden {
            display: none;
        }

        .status {
            text-align: center;
            padding: 18px;
            margin: 25px 0;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .total-overview {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
            border: 2px solid #dee2e6;
            width: 100%;
            box-sizing: border-box;
        }

        .workline-totals {
            display: flex;
            justify-content: flex-start;
            gap: 18px;
            flex-wrap: wrap;
        }

        .workline-total {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid #1976d2;
            min-width: 140px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .workline-total .name {
            font-weight: 600;
            color: #1565c0;
            font-size: 1em;
            margin-bottom: 5px;
        }

        .workline-total .hours {
            font-size: 1.4em;
            color: #0d47a1;
            font-weight: 700;
        }

        .grand-total {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border: 2px solid #4caf50;
            padding: 15px 20px;
            border-radius: 10px;
            min-width: 160px;
            box-shadow: 0 4px 12px rgba(76,175,80,0.2);
        }

        .grand-total .name {
            font-weight: 600;
            color: #2e7d32;
            font-size: 1em;
            margin-bottom: 5px;
        }

        .grand-total .hours {
            font-size: 1.4em;
            color: #1b5e20;
            font-weight: 700;
        }

        .grand-total.warning {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border-color: #f44336;
            box-shadow: 0 4px 12px rgba(244,67,54,0.2);
        }

        .grand-total.warning .name {
            color: #c62828;
        }

        .grand-total.warning .hours {
            color: #b71c1c;
        }

        .all-registrations-overview {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }

        .all-registrations-overview pre {
            background: #fff;
            padding: 20px;
            margin: 0;
            border-radius: 0;
            font-size: 0.9em;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
            min-height: 100px;
            line-height: 1.4;
        }

        .overig-description {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1.3em;
            background: #fff;
        }

        .overig-description:focus {
            outline: none;
            border-color: #0063ac;
            box-shadow: 0 0 0 3px rgba(0,99,172,0.1);
        }

        /* Auto-upload indicator */
        .upload-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            z-index: 1001;
            transition: all 0.3s ease;
            display: none;
        }

        .upload-indicator.uploading {
            background: #ffc107;
            color: #212529;
        }

        .upload-indicator.error {
            background: #dc3545;
            color: white;
        }

        @media (max-width: 1100px) {
            .employee-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 10px;
            }
            
            .workline-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .employee-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
            }
            
            .workline-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .user-info {
                font-size: 1em;
                padding: 10px 14px;
                margin-right: 15px;
            }
            
            .hour-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .hour-buttons-group {
                justify-content: center;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header-buttons {
                justify-content: center;
                flex-direction: column;
                gap: 15px;
            }
            
            .planning-upload-section {
                order: -1;
            }

            .day-buttons {
                justify-content: center;
            }

            .upload-indicator {
                top: 10px;
                right: 10px;
                padding: 10px 14px;
                font-size: 0.9em;
            }
        }

        @media (max-width: 600px) {
            .employee-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .workline-grid {
                grid-template-columns: 1fr;
            }

            .day-btn {
                min-width: 100px;
                padding: 10px 12px;
            }
        }

        @media (hover: none) {
            .employee-btn:hover,
            .workline-btn:hover,
            .hour-btn:hover,
            .btn:hover,
            .btn-primary:hover {
                transform: none;
                box-shadow: none;
            }
        }
    
        .modal-status {
    position: absolute;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2000;
    min-width: 300px;
    text-align: center;
    padding: 15px 20px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1.1em;
}

.modal-status.error {
    background: #f8d7da;
    color: #721c24;
    border: 2px solid #f5c6cb;
}
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Tijdregistratie</h1>
            <div class="header-buttons">
                <div class="planning-upload-section">
                    <input type="file" id="planning-file" class="file-input" accept=".csv" onchange="loadPlanningCSV(event)" style="display: none;">
                    <button class="btn-upload" onclick="document.getElementById('planning-file').click()">
                        📊 Planning laden
                    </button>
                    <span id="file-name-display" class="file-name-display"></span>
                </div>
                <div id="auth-buttons">
                    <span id="user-info" class="user-info"></span>
                    <button id="sign-in-btn" class="btn-auth" onclick="signInToMicrosoft()">
                        Inloggen Microsoft
                    </button>
                    <button id="sign-out-btn" class="btn-auth sign-out" onclick="signOut()" style="display: none;">
                        Uitloggen
                    </button>
                </div>
            </div>
        </div>

        <!-- Upload indicator -->
        <div id="upload-indicator" class="upload-indicator">
            <span id="upload-indicator-text">Auto-upload actief</span>
        </div>

        <div class="section">
            <div class="planning-section">
                <h3>📅 Personeelsplanning</h3>
                
                <div id="planning-display" style="display: none;">
                    <div style="margin: 20px 0;">
                        <div style="font-weight: bold; color: #495057; font-size: 1.3em; margin-bottom: 20px;">
                            <span id="planning-info"></span>
                        </div>
                        
                        <div class="planning-filters">
                            <div class="planning-filter-group">
                                <label class="planning-filter-label">Ploeg:</label>
                                <div class="filter-buttons" id="ploeg-buttons">
                                    <button class="filter-btn active" onclick="filterByPloeg('')">Alle ploegen</button>
                                </div>
                            </div>
                            
                            <div class="planning-filter-group">
                                <label class="planning-filter-label">Afdeling:</label>
                                <div class="filter-buttons" id="afdeling-buttons">
                                    <button class="filter-btn active" onclick="filterByAfdeling('')">Alle afdelingen</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="planning-table-wrapper">
                        <table class="planning-table" id="planning-table">
                            <thead id="planning-head"></thead>
                            <tbody id="planning-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="no-planning-message" style="text-align: center; padding: 40px; color: #6c757d; font-size: 1.2em;">
                    📊 Upload een personeelsplanning CSV bestand via de knop bovenaan om te beginnen
                </div>
            </div>
        </div>

        <div class="modal" id="hours-modal">
            <div class="modal-content hours-modal-content">
                <div class="modal-header">
                    <h2 id="hours-modal-title">Urenregistratie voor [Werknemer]</h2>
                    <button class="btn-close" onclick="closeHoursModal()">&times;</button>
                </div>
                
                <div class="section" id="modal-date-selection">
                    <h3>1. Selecteer datum voor registratie:</h3>
                    
                    <div class="date-selection-section">
                        <div class="current-week" id="modal-current-week-display">
                            <!-- Wordt dynamisch gevuld -->
                        </div>
                        
                        <div class="day-buttons" id="modal-day-buttons">
                            <!-- Wordt dynamisch gevuld met dagen van de week -->
                        </div>
                    </div>
                </div>
                
                <div class="section hidden" id="modal-workline-selection">
                    <h3>2. Kies afdeling:</h3>
                    <div id="modal-workline-grid" class="workline-grid">
                        <button class="workline-btn" onclick="selectWorkLineInModal('schillijn')">Schillijn</button>
                        <button class="workline-btn" onclick="selectWorkLineInModal('inpakken')">Inpakken</button>
                        <button class="workline-btn" onclick="selectWorkLineInModal('sousvide')">Sous-vide</button>
                        <button class="workline-btn" onclick="selectWorkLineInModal('koelcel')">Koelcel</button>
                        <button class="workline-btn" onclick="selectWorkLineInModal('fusthal')">Fusthal</button>
                        <button class="workline-btn" onclick="selectWorkLineInModal('puree')">Puree</button>
                    </div>
                </div>

                <div class="total-overview hidden" id="modal-total-overview">
                    <div class="workline-totals" id="modal-workline-totals">
                    </div>
                </div>

                <div class="section hidden" id="modal-hours-registration">
                    <h3>3. Voer aantal uren per activiteit in:</h3>
                    
                    <table class="activities-table">
                        <thead>
                            <tr>
                                <th>Activiteit</th>
                                <th style="text-align: center;">Aantal uren</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="modal-activities-tbody">
                        </tbody>
                    </table>
                    
                    <div class="controls">
                        <button class="btn btn-secondary" onclick="closeHoursModal()">Annuleren</button>
                        <button class="btn btn-primary" onclick="saveRegistrationFromModal()">Opslaan</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="status-message"></div>

        <div class="section">
            <div class="controls" style="display: flex; justify-content: center;">
                <button class="btn-uniform btn-yellow" onclick="toggleDataManagement()">Beheer opties</button>
            </div>
            
            <div class="hidden" id="data-management">
                <div class="controls" style="margin-top: 15px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button id="send-data-btn" class="btn-uniform" onclick="sendData()">Gegevens versturen</button>
                    <button class="btn-uniform" onclick="downloadCSV()">Download alle CSV</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://alcdn.msauth.net/browser/2.32.2/js/msal-browser.min.js"></script>
    <script>
        let selectedDate = null;
        let currentWeekStart = null;

        function initializeDates() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - daysFromMonday);
            currentWeekStart.setHours(0, 0, 0, 0);
            
            selectedDate = new Date(today);
            selectedDate.setHours(0, 0, 0, 0);
        }

        function updateModalWeekDisplay() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(currentWeekStart.getDate() + 6);
            
            const options = { day: 'numeric', month: 'short' };
            const startStr = currentWeekStart.toLocaleDateString('nl-NL', options);
            const endStr = weekEnd.toLocaleDateString('nl-NL', options);
            const year = currentWeekStart.getFullYear();
            
            const modalWeekDisplay = document.getElementById('modal-current-week-display');
            if (modalWeekDisplay) {
                modalWeekDisplay.textContent = 
                    `Week ${getWeekNumber(currentWeekStart)} - ${startStr} t/m ${endStr} ${year}`;
            }
        }

        function updateModalDayButtons() {
            const dayButtons = document.getElementById('modal-day-buttons');
            if (!dayButtons) return;
            
            dayButtons.innerHTML = '';
            
            const days = ['Maandag', 'Dinsdag', 'Woensdag', 'Donderdag', 'Vrijdag'];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            days.forEach((dayName, index) => {
                const date = new Date(currentWeekStart);
                date.setDate(currentWeekStart.getDate() + index);
                
                const button = document.createElement('button');
                button.className = 'day-btn';
                button.textContent = `${dayName}\n${date.getDate()}/${date.getMonth() + 1}`;
                
                if (date.getTime() === today.getTime()) {
                    button.classList.add('today');
                } else if (date > today) {
                    button.classList.add('future');
                    button.disabled = true;
                }
                
                if (date.getTime() === selectedDate.getTime()) {
                    button.classList.add('selected');
                }
                
                if (date <= today) {
                    button.onclick = () => selectModalDate(date);
                }
                
                dayButtons.appendChild(button);
            });
        }

        function selectModalDate(date) {
            selectedDate = new Date(date);
            selectedDate.setHours(0, 0, 0, 0);
            
            updateModalDayButtons();
            updateModalSelectedDateDisplay();
            
            // Reset workline selection when date changes
            currentWorkLine = null;
            document.getElementById('modal-workline-selection').classList.add('hidden');
            document.getElementById('modal-hours-registration').classList.add('hidden');
            document.getElementById('modal-total-overview').classList.add('hidden');
            
            // Reload existing registrations for new date
            if (currentEmployee) {
                loadExistingRegistrationsForSelectedDate(currentEmployee);
                updateWorklineButtonsWithExistingHours();
                
                // Show workline selection after date is selected
                document.getElementById('modal-workline-selection').classList.remove('hidden');
            }
        }

        function updateModalSelectedDateDisplay() {
            // Update modal title only
            if (currentEmployee) {
                document.getElementById('hours-modal-title').textContent = 
                    `Urenregistratie voor ${currentEmployee} - ${selectedDate.toLocaleDateString('nl-NL')}`;
            }
        }

        function getWeekNumber(date) {
            const tempDate = new Date(date);
            tempDate.setHours(0, 0, 0, 0);
            tempDate.setDate(tempDate.getDate() + 3 - (tempDate.getDay() + 6) % 7);
            const week1 = new Date(tempDate.getFullYear(), 0, 4);
            return 1 + Math.round(((tempDate - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        const REDIRECT_URI = 'https://sh-online.github.io/tijdregistratie/';
        
        const msalConfig = {
            auth: {
                clientId: 'b6bac90f-29af-4137-a5f0-be4387796f56',
                authority: 'https://login.microsoftonline.com/common',
                redirectUri: REDIRECT_URI
            },
            cache: {
                cacheLocation: 'localStorage',
                storeAuthStateInCookie: false
            }
        };

        const loginRequest = {
            scopes: ['Files.ReadWrite', 'User.Read'],
            redirectUri: REDIRECT_URI
        };

        let msalInstance;
        let account = null;

        const workLines = {
            'schillijn': {
                name: 'Schillijn',
                activities: ['Produceren', 'Lezen', 'Sous-vide', 'Herbewerken', 'Schoonmaken', 'Overig']
            },
            'inpakken': {
                name: 'Inpakken', 
                activities: ['Produceren', 'Kratten', 'Herbewerken', 'Schoonmaken', 'Overig']
            },
            'sousvide': {
                name: 'Sous-vide',
                activities: ['Gea', 'Overpakken', 'Sleeven', 'Lossnijden', 'Schoonmaken', 'Overig']
            },
            'koelcel': {
                name: 'Koelcel',
                activities: ['Orderpicken', 'Overpakken', 'Voorraadopname', 'Schoonmaken', 'Herbewerken', 'Overig']
            },
            'fusthal': {
                name: 'Fusthal',
                activities: ['Wassen', 'Schoonmaken', 'Overig']
            },
            'puree': {
                name: 'Puree',
                activities: ['Produceren', 'Inpakken', 'Schoonmaken', 'Herbewerken', 'Overig']
            }
        };
        
        let employees = [
            'Agnieszka', 'Aniel', 'Arkadiusz', 'Biniam', 'Biyik', 'Boa', 'Fred', 'Herman', 
            'Kamila', 'Klaas', 'Magda', 'Mustafa', 'Okan', 'Paul', 'Paula', 'Rakesh', 
            'Randhir', 'Rein', 'Roy', 'Samantha', 'Sen', 'Stefan', 'Willem-Jan', 'Wubbe',
            'BDE Agniezka Ircha', 'BDE Amber', 'BDE Ewelina', 'BDE Jessica', 'BDE Krzystof',
            'BDE Monika', 'BDE Patryk', 'BDE Paulina', 'BDE Saraela', 'BDE Uliana',
            'BDE Yaroslav', 'BDE Mahmut', 'BDE Przemyslaw', 'BDE Ewa', 'BDE Man'
        ];
        
        let registrations = [];
        let currentEmployee = null;
        let currentWorkLine = null;
        let multiWorkLineData = {};
        let planningData = [];
        let allPlanningData = [];
        let planningHeader = [];

        // Enhanced upload tracking variables
        let registrationCounter = 0; // Track number of registrations since last upload
        const UPLOAD_TRIGGER_COUNT = 10; // Upload after every 10 registrations

        function showStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            
            setTimeout(() => {
                statusEl.textContent = '';
                statusEl.className = '';
            }, 4000);
        }

        function showUploadIndicator(message, type = 'success') {
            const indicator = document.getElementById('upload-indicator');
            const text = document.getElementById('upload-indicator-text');
            
            indicator.className = `upload-indicator ${type}`;
            text.textContent = message;
            indicator.style.display = 'block';
            
            // Auto-hide after 3 seconds for success, 5 seconds for others
            const hideTime = type === 'success' ? 3000 : 5000;
            setTimeout(() => {
                indicator.style.display = 'none';
            }, hideTime);
        }

        function toggleDataManagement() {
            const managementEl = document.getElementById('data-management');
            const btnEl = event.target;
            
            if (managementEl.classList.contains('hidden')) {
                managementEl.classList.remove('hidden');
                btnEl.textContent = 'Verberg opties';
            } else {
                managementEl.classList.add('hidden');
                btnEl.textContent = 'Beheer opties';
            }
        }

        function closeHoursModal() {
            document.getElementById('hours-modal').classList.remove('show');
            currentEmployee = null;
            currentWorkLine = null;
            multiWorkLineData = {};
            
            // Reset modal state
            document.getElementById('modal-date-selection').classList.remove('hidden');
            document.getElementById('modal-workline-selection').classList.add('hidden');
            document.getElementById('modal-hours-registration').classList.add('hidden');
            document.getElementById('modal-total-overview').classList.add('hidden');
        }

        function loadPlanningCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Display filename without .csv extension
            const fileName = file.name.replace(/\.csv$/i, '');
            const fileNameDisplay = document.getElementById('file-name-display');
            fileNameDisplay.textContent = fileName;
            fileNameDisplay.style.display = 'inline-block';
            
            showStatus('CSV bestand laden...', 'success');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                let csv = e.target.result;
                
                if (csv.charCodeAt(0) === 0xFEFF) {
                    csv = csv.slice(1);
                }
                
                parsePlanningCSV(csv);
                
                // Trigger auto-upload after planning is loaded
                setTimeout(async () => {
                    if (account && registrations && registrations.length > 0) {
                        showUploadIndicator('Auto-upload na planning laden...', 'uploading');
                        await sendDataReliable();
                    }
                }, 2000); // Wait 2 seconds to let the planning load complete
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        function parsePlanningCSV(csvText) {
            try {
                csvText = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
                
                const lines = csvText.split('\n');
                
                if (lines.length < 1) {
                    showStatus('CSV bestand is leeg', 'error');
                    return;
                }
                
                const firstLine = lines[0];
                let delimiter = ';';
                let header = [];
                
                let testHeader = firstLine.split(';').map(h => h.trim());
                
                if (testHeader.length > 1) {
                    delimiter = ';';
                    header = testHeader;
                } else {
                    testHeader = firstLine.split(',').map(h => h.trim());
                    
                    if (testHeader.length > 1) {
                        delimiter = ',';
                        header = testHeader;
                    } else {
                        testHeader = firstLine.split('\t').map(h => h.trim());
                        
                        if (testHeader.length > 1) {
                            delimiter = '\t';
                            header = testHeader;
                        } else {
                            showStatus('Kan geen juiste delimiter vinden. Probeer een ander CSV formaat.', 'error');
                            return;
                        }
                    }
                }
                
                if (lines.length < 2) {
                    showStatus('CSV heeft alleen een header, geen data regels', 'error');
                    return;
                }
                
                planningHeader = header;
                allPlanningData = [];
                let successCount = 0;
                let skipCount = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) {
                        skipCount++;
                        continue;
                    }
                    
                    const row = line.split(delimiter).map(cell => cell.trim());
                    
                    if (row.length !== header.length) {
                        skipCount++;
                        continue;
                    }
                    
                    const employee = {};
                    header.forEach((col, index) => {
                        employee[col] = row[index];
                    });
                    
                    const nameField = employee.Naam || employee.naam || employee.Name || employee.name || 
                                    employee.NAAM || employee.Werknemer || employee.werknemer;
                    
                    if (nameField && nameField.trim() && nameField !== '') {
                        allPlanningData.push(employee);
                        successCount++;
                    } else {
                        skipCount++;
                    }
                }
                
                if (allPlanningData.length === 0) {
                    showStatus(`Geen geldige medewerkergegevens gevonden. Controleer of er een naam kolom is. Gevonden kolommen: ${header.join(', ')}`, 'error');
                    return;
                }
                
                planningData = [...allPlanningData];
                
                updatePloegFilter();
                
                displayPlanningTable();
                showStatus(`Planning geladen: ${allPlanningData.length} medewerkers (${skipCount} regels overgeslagen)`, 'success');
                
            } catch (error) {
                showStatus('Fout bij laden CSV: ' + error.message, 'error');
            }
        }

        function updatePloegFilter() {
            const ploegButtons = document.getElementById('ploeg-buttons');
            const afdelingButtons = document.getElementById('afdeling-buttons');
            
            const ploegen = [...new Set(allPlanningData.map(emp => emp.Ploeg || emp.ploeg))].filter(Boolean).sort();
            ploegButtons.innerHTML = '<button class="filter-btn active" onclick="filterByPloeg(\'\')">Alle ploegen</button>';
            ploegen.forEach(ploeg => {
                const button = document.createElement('button');
                button.className = 'filter-btn';
                button.textContent = ploeg;
                button.onclick = () => filterByPloeg(ploeg);
                ploegButtons.appendChild(button);
            });
            
            const afdelingen = [...new Set(allPlanningData.map(emp => emp.Afdeling || emp.afdeling))].filter(Boolean).sort();
            afdelingButtons.innerHTML = '<button class="filter-btn active" onclick="filterByAfdeling(\'\')">Alle afdelingen</button>';
            afdelingen.forEach(afdeling => {
                const button = document.createElement('button');
                button.className = 'filter-btn';
                button.textContent = afdeling;
                button.onclick = () => filterByAfdeling(afdeling);
                afdelingButtons.appendChild(button);
            });
        }

        let currentPloegFilter = '';
        let currentAfdelingFilter = '';

        function filterByPloeg(ploeg) {
            currentPloegFilter = ploeg;
            
            document.querySelectorAll('#ploeg-buttons .filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if ((ploeg === '' && btn.textContent === 'Alle ploegen') || btn.textContent === ploeg) {
                    btn.classList.add('active');
                }
            });
            
            applyFilters();
        }

        function filterByAfdeling(afdeling) {
            currentAfdelingFilter = afdeling;
            
            document.querySelectorAll('#afdeling-buttons .filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if ((afdeling === '' && btn.textContent === 'Alle afdelingen') || btn.textContent === afdeling) {
                    btn.classList.add('active');
                }
            });
            
            applyFilters();
        }

        function applyFilters() {
            planningData = allPlanningData.filter(emp => {
                let matches = true;
                
                if (currentPloegFilter && (emp.Ploeg || emp.ploeg) !== currentPloegFilter) {
                    matches = false;
                }
                
                if (currentAfdelingFilter && (emp.Afdeling || emp.afdeling) !== currentAfdelingFilter) {
                    matches = false;
                }
                
                return matches;
            });
            
            displayPlanningTable();
            updatePlanningInfo();
        }

        function updatePlanningInfo() {
            const planningInfo = document.getElementById('planning-info');
            
            let infoText = `${planningData.length} medewerkers`;
            
            const filters = [];
            if (currentPloegFilter) filters.push(`ploeg: ${currentPloegFilter}`);
            if (currentAfdelingFilter) filters.push(`afdeling: ${currentAfdelingFilter}`);
            
            if (filters.length > 0) {
                infoText += ` (${filters.join(', ')})`;
            } else {
                infoText += ' (alle ploegen en afdelingen)';
            }
            
            planningInfo.textContent = infoText;
        }

        function displayPlanningTable() {
            const tableHead = document.getElementById('planning-head');
            const tableBody = document.getElementById('planning-body');
            
            tableHead.innerHTML = '';
            const headerRow = document.createElement('tr');
            
            // Track column status for header coloring
            const columnStatus = {};
            
            planningHeader.forEach((col, index) => {
                if (index === 0 || index === 1) return;
                
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
                
                if (col.includes('plan')) {
                    const thWerkelijk = document.createElement('th');
                    thWerkelijk.textContent = col.replace('plan', 'uren');
                    thWerkelijk.className = 'werkelijk-header';
                    
                    // We'll set the status class after analyzing all data
                    columnStatus[col] = { 
                        element: thWerkelijk, 
                        hasData: false, 
                        hasIssues: false, 
                        hasPending: false 
                    };
                    
                    headerRow.appendChild(thWerkelijk);
                }
            });
            tableHead.appendChild(headerRow);
            
            tableBody.innerHTML = '';
            planningData.forEach(emp => {
                const row = document.createElement('tr');
                
                planningHeader.forEach((col, index) => {
                    if (index === 0 || index === 1) return;
                    
                    const cell = document.createElement('td');
                    let cellData = emp[col] || '';
                    
                    const isNameColumn = col.toLowerCase().includes('naam') || col.toLowerCase() === 'naam' || 
                                       col.toLowerCase() === 'name' || col.toLowerCase() === 'werknemer';
                    
                    if (isNameColumn) {
                        const employeeName = cellData;
                        cell.style.cursor = 'pointer';
                        cell.style.transition = 'all 0.2s';
                        cell.style.fontWeight = '600';
                        cell.style.color = '#0063ac';
                        cell.style.padding = '15px 12px';
                        cell.className = 'clickable-name-cell';
                        
                        cell.onclick = () => startUrenRegistratie(employeeName);
                        
                        cell.onmouseover = () => {
                            cell.style.backgroundColor = '#007bff';
                            cell.style.color = 'white';
                            cell.style.transform = 'scale(1.02)';
                        };
                        cell.onmouseout = () => {
                            cell.style.backgroundColor = 'transparent';
                            cell.style.color = '#0063ac';
                            cell.style.transform = 'scale(1)';
                        };
                        
                        cell.title = `Klik om uren in te voeren voor ${employeeName}`;
                    }
                    
                    cell.textContent = cellData;
                    row.appendChild(cell);
                    
                    if (col.includes('plan')) {
                        const werkelijkCell = document.createElement('td');
                        
                        let dag = '';
                        if (col.includes('Ma')) dag = 'maandag';
                        else if (col.includes('Di')) dag = 'dinsdag';
                        else if (col.includes('Wo')) dag = 'woensdag';
                        else if (col.includes('Do')) dag = 'donderdag';
                        else if (col.includes('Vr')) dag = 'vrijdag';
                        
                        const werkelijkeUren = getWerkelijkeUren(emp.Naam || emp.naam, dag);
                        
                        // Better parsing of planned hours - handle both comma and dot decimals
                        let geplandeUrenString = emp[col] || '0';
                        if (typeof geplandeUrenString === 'string') {
                            // Replace comma with dot for decimal parsing
                            geplandeUrenString = geplandeUrenString.replace(',', '.');
                        }
                        const geplandeUren = parseFloat(geplandeUrenString) || 0;
                        
                        werkelijkCell.textContent = werkelijkeUren > 0 ? werkelijkeUren.toFixed(2) : '-';
                        
                        if (werkelijkeUren > 0) {
                            // Round both values to 2 decimal places for accurate comparison
                            const werkelijkRounded = Math.round(werkelijkeUren * 100) / 100;
                            const geplandRounded = Math.round(geplandeUren * 100) / 100;
                            const afwijking = Math.abs(werkelijkRounded - geplandRounded);
                            
                            columnStatus[col].hasData = true;
                            
                            if (afwijking < 0.01) { // Practically zero (accounting for floating point)
                                werkelijkCell.className = 'werkelijk-cell exact';
                            } else if (afwijking <= 1.0) {
                                werkelijkCell.className = 'werkelijk-cell close';
                                columnStatus[col].hasIssues = true;
                            } else {
                                werkelijkCell.className = 'werkelijk-cell far';
                                columnStatus[col].hasIssues = true;
                            }
                        } else {
                            // Check if this is today and there are planned hours
                            const today = new Date();
                            const dagNummers = {
                                'maandag': 1, 'dinsdag': 2, 'woensdag': 3, 'donderdag': 4, 'vrijdag': 5
                            };
                            const isToday = today.getDay() === dagNummers[dag];
                            
                            if (isToday && geplandeUren > 0) {
                                werkelijkCell.className = 'werkelijk-cell pending';
                                werkelijkCell.textContent = '-';
                                columnStatus[col].hasPending = true;
                            } else if (geplandeUren > 0) {
                                werkelijkCell.className = 'werkelijk-cell empty';
                                columnStatus[col].hasIssues = true; // Missing data counts as issue
                            } else {
                                werkelijkCell.className = 'werkelijk-cell empty';
                            }
                        }
                        
                        row.appendChild(werkelijkCell);
                    }
                });
                tableBody.appendChild(row);
            });
            
            // Apply status classes to column headers
            Object.entries(columnStatus).forEach(([col, status]) => {
                if (status.hasPending || !status.hasData) {
                    // Red: nothing filled in or pending items
                    status.element.classList.add('status-empty');
                } else if (status.hasIssues) {
                    // Yellow: everything filled but has issues
                    status.element.classList.add('status-partial');
                } else {
                    // Green: everything correct
                    status.element.classList.add('status-complete');
                }
            });
            
            updatePlanningInfo();
            
            document.getElementById('planning-display').style.display = 'block';
            document.getElementById('no-planning-message').style.display = 'none';
        }

        function getWerkelijkeUren(employeeName, dag) {
            if (!registrations || !employeeName || !dag) return 0;
            
            const dagNummers = {
                'maandag': 0,
                'dinsdag': 1, 
                'woensdag': 2,
                'donderdag': 3,
                'vrijdag': 4
            };
            
            const targetDate = new Date(currentWeekStart);
            targetDate.setDate(currentWeekStart.getDate() + dagNummers[dag]);
            const targetDateString = targetDate.getFullYear() + '-' + 
    String(targetDate.getMonth() + 1).padStart(2, '0') + '-' + 
    String(targetDate.getDate()).padStart(2, '0');
            
            let totalHours = 0;
            
            registrations.forEach(reg => {
                if (reg.employee === employeeName && reg.date === targetDateString) {
                    if (reg.hours && typeof reg.hours === 'object') {
                        if (reg.workLineNames && typeof reg.hours === 'object' && !Array.isArray(reg.hours)) {
                            Object.entries(reg.hours).forEach(([workLineKey, activities]) => {
                                Object.values(activities).forEach(hours => {
                                    totalHours += parseFloat(hours) || 0;
                                });
                            });
                        } else {
                            Object.values(reg.hours).forEach(hours => {
                                totalHours += parseFloat(hours) || 0;
                            });
                        }
                    }
                }
            });
            
            return totalHours;
        }

        function startUrenRegistratie(employeeName) {
            currentEmployee = employeeName;
            currentWorkLine = null;
            multiWorkLineData = {};
            
            // Reset selected date to today when starting new registration
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            selectedDate = new Date(today);
            
            loadExistingRegistrationsForSelectedDate(employeeName);
            
            document.getElementById('hours-modal-title').textContent = 
                `Urenregistratie voor ${employeeName}`;
            
            // Show date selection first
            document.getElementById('modal-date-selection').classList.remove('hidden');
            document.getElementById('modal-workline-selection').classList.add('hidden');
            document.getElementById('modal-hours-registration').classList.add('hidden');
            document.getElementById('modal-total-overview').classList.add('hidden');
            
            // Initialize modal date displays
            updateModalWeekDisplay();
            updateModalDayButtons();
            updateModalSelectedDateDisplay();
            
            updateWorklineButtonsWithExistingHours();
            
            document.getElementById('hours-modal').classList.add('show');
            
            const existingHours = getTotalHoursForSelectedDate(employeeName);
            if (existingHours > 0) {
                showStatus(`Bestaande registratie geladen voor ${employeeName} (${existingHours.toFixed(2)}u op ${selectedDate.toLocaleDateString('nl-NL')})`, 'success');
            } else {
                showStatus(`Nieuwe urenregistratie voor ${employeeName} op ${selectedDate.toLocaleDateString('nl-NL')}`, 'success');
            }
            
            // Automatically show workline selection after a short delay
            setTimeout(() => {
                document.getElementById('modal-workline-selection').classList.remove('hidden');
            }, 500);
        }

        function loadExistingRegistrationsForSelectedDate(employeeName) {
            const selectedDateString = selectedDate.getFullYear() + '-' + 
    String(selectedDate.getMonth() + 1).padStart(2, '0') + '-' + 
    String(selectedDate.getDate()).padStart(2, '0');
            
            const selectedDateRegistrations = registrations.filter(reg => 
                reg.employee === employeeName && reg.date === selectedDateString
            );
            
            multiWorkLineData = {};
            
            selectedDateRegistrations.forEach(reg => {
                if (reg.hours && typeof reg.hours === 'object') {
                    if (reg.workLineNames && typeof reg.hours === 'object' && !Array.isArray(reg.hours)) {
                        Object.entries(reg.hours).forEach(([workLineKey, activities]) => {
                            if (!multiWorkLineData[workLineKey]) {
                                multiWorkLineData[workLineKey] = {};
                            }
                            
                            Object.entries(activities).forEach(([activity, hours]) => {
                                if (multiWorkLineData[workLineKey][activity]) {
                                    multiWorkLineData[workLineKey][activity] += parseFloat(hours);
                                } else {
                                    multiWorkLineData[workLineKey][activity] = parseFloat(hours);
                                }
                            });
                        });
                    } else if (reg.workLineName) {
                        const workLineKey = Object.keys(workLines).find(key => workLines[key].name === reg.workLineName);
                        if (workLineKey) {
                            if (!multiWorkLineData[workLineKey]) {
                                multiWorkLineData[workLineKey] = {};
                            }
                            
                            Object.entries(reg.hours).forEach(([activity, hours]) => {
                                if (multiWorkLineData[workLineKey][activity]) {
                                    multiWorkLineData[workLineKey][activity] += parseFloat(hours);
                                } else {
                                    multiWorkLineData[workLineKey][activity] = parseFloat(hours);
                                }
                            });
                        }
                    }
                }
            });
        }

        function getTotalHoursForSelectedDate(employeeName) {
            const selectedDateString = selectedDate.getFullYear() + '-' + 
    String(selectedDate.getMonth() + 1).padStart(2, '0') + '-' + 
    String(selectedDate.getDate()).padStart(2, '0');
            let totalHours = 0;
            
            registrations.forEach(reg => {
                if (reg.employee === employeeName && reg.date === selectedDateString) {
                    if (reg.hours && typeof reg.hours === 'object') {
                        if (reg.workLineNames && typeof reg.hours === 'object' && !Array.isArray(reg.hours)) {
                            Object.entries(reg.hours).forEach(([workLineKey, activities]) => {
                                Object.values(activities).forEach(hours => {
                                    totalHours += parseFloat(hours) || 0;
                                });
                            });
                        } else {
                            Object.values(reg.hours).forEach(hours => {
                                totalHours += parseFloat(hours) || 0;
                            });
                        }
                    }
                }
            });
            
            return totalHours;
        }

        function selectWorkLineInModal(workLineKey) {
            if (currentWorkLine) {
                saveCurrentWorkLineDataInModal();
            }
            
            document.querySelectorAll('#modal-workline-grid .workline-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            currentWorkLine = workLineKey;
            
            const workLine = workLines[workLineKey];
            document.getElementById('modal-hours-registration').classList.remove('hidden');
            document.getElementById('modal-total-overview').classList.remove('hidden');
            
            generateActivitiesTableInModal(workLine.activities);
            loadWorkLineDataInModal(workLineKey);
            updateTotalOverviewInModal();
            
            if (multiWorkLineData[workLineKey] && Object.keys(multiWorkLineData[workLineKey]).length > 0) {
                const existingHours = Object.values(multiWorkLineData[workLineKey]).reduce((sum, hours) => sum + hours, 0);
                showStatus(`Bestaande uren geladen voor ${workLine.name}: ${existingHours.toFixed(2)}u`, 'success');
            }
        }

        function saveCurrentWorkLineDataInModal() {
            if (!currentWorkLine) return;
            
            const activities = workLines[currentWorkLine].activities;
            const workLineData = {};
            
            activities.forEach(activity => {
                const inputId = 'modal-' + activity.toLowerCase().replace(/[^a-z0-9]/g, '') + '-hours';
                const input = document.getElementById(inputId);
                if (input && input.value && input.value !== '0') {
                    const hours = parseFloat(input.value);
                    if (hours > 0) {
                        let activityName = activity;
                        if (activity.toLowerCase() === 'overig') {
                            const descriptionInput = document.getElementById(inputId + '-description');
                            if (descriptionInput && descriptionInput.value.trim()) {
                                activityName = `Overig: ${descriptionInput.value.trim()}`;
                            }
                        }
                        workLineData[activityName] = hours;
                    }
                }
            });
            
            if (Object.keys(workLineData).length > 0) {
                multiWorkLineData[currentWorkLine] = workLineData;
            } else {
                delete multiWorkLineData[currentWorkLine];
            }
        }

        function loadWorkLineDataInModal(workLineKey) {
            const activities = workLines[workLineKey].activities;
            
            activities.forEach(activity => {
                const inputId = 'modal-' + activity.toLowerCase().replace(/[^a-z0-9]/g, '') + '-hours';
                const input = document.getElementById(inputId);
                if (input) {
                    let savedHours = 0;
                    let savedDescription = '';
                    
                    if (multiWorkLineData[workLineKey]) {
                        if (multiWorkLineData[workLineKey][activity]) {
                            savedHours = multiWorkLineData[workLineKey][activity];
                        } else if (activity.toLowerCase() === 'overig') {
                            for (let key in multiWorkLineData[workLineKey]) {
                                if (key.startsWith('Overig:')) {
                                    savedHours = multiWorkLineData[workLineKey][key];
                                    savedDescription = key.substring(7).trim();
                                    break;
                                }
                            }
                        }
                    }
                    
                    input.value = savedHours;
                    
                    if (activity.toLowerCase() === 'overig' && savedDescription) {
                        const descriptionInput = document.getElementById(inputId + '-description');
                        if (descriptionInput) {
                            descriptionInput.value = savedDescription;
                        }
                    }
                }
            });
        }

        function updateTotalOverviewInModal() {
            const overviewEl = document.getElementById('modal-total-overview');
            const totalsEl = document.getElementById('modal-workline-totals');
            
            if (currentWorkLine) {
                saveCurrentWorkLineDataInModal();
            }
            
            totalsEl.innerHTML = '';
            
            let grandTotal = 0;
            
            Object.entries(multiWorkLineData).forEach(([workLineKey, activities]) => {
                const workLineName = workLines[workLineKey].name;
                const workLineTotal = Object.values(activities).reduce((sum, hours) => sum + hours, 0);
                grandTotal += workLineTotal;
                
                const workLineDiv = document.createElement('div');
                workLineDiv.className = 'workline-total';
                workLineDiv.innerHTML = `
                    <div class="name">${workLineName}</div>
                    <div class="hours">${workLineTotal.toFixed(2)}u</div>
                `;
                totalsEl.appendChild(workLineDiv);
            });
            
            const grandTotalDiv = document.createElement('div');
            grandTotalDiv.className = grandTotal > 8 ? 'grand-total warning' : 'grand-total';
            grandTotalDiv.innerHTML = `
                <div class="name">TOTAAL</div>
                <div class="hours">${grandTotal.toFixed(2)}u</div>
            `;
            totalsEl.appendChild(grandTotalDiv);
            
            if (currentWorkLine) {
                overviewEl.classList.remove('hidden');
            } else {
                overviewEl.classList.add('hidden');
            }
        }

        function generateActivitiesTableInModal(activities) {
            const tbody = document.getElementById('modal-activities-tbody');
            tbody.innerHTML = '';
            
            activities.forEach(activity => {
                const activityId = 'modal-' + activity.toLowerCase().replace(/[^a-z0-9]/g, '') + '-hours';
                const row = document.createElement('tr');
                
                const isOverig = activity.toLowerCase() === 'overig';
                const activityDisplay = isOverig ? 
                    `<input type="text" placeholder="Overig, Namelijk:" id="${activityId}-description" 
                     class="overig-description">` : 
                    activity;
                
                row.innerHTML = `
                    <td>${activityDisplay}</td>
                    <td>
                        <div class="hour-controls">
                            <div class="hour-buttons-group">
                                <button class="hour-btn minus" onclick="changeHoursInModal('${activityId}', -1)">-1</button>
                                <button class="hour-btn minus" onclick="changeHoursInModal('${activityId}', -0.25)">-0,25</button>
                                <input type="number" class="hour-input" id="${activityId}" min="0" max="12" step="0.25" value="0" readonly>
                                <button class="hour-btn plus" onclick="changeHoursInModal('${activityId}', 0.25)">+0,25</button>
                                <button class="hour-btn plus" onclick="changeHoursInModal('${activityId}', 1)">+1</button>
                                <button class="hour-btn plus" onclick="changeHoursInModal('${activityId}', 4)">+4</button>
                                <button class="btn-fullday" onclick="setFullDayInModal('${activityId}')">Dag</button>
                            </div>
                        </div>
                    </td>
                    <td>
                        <button class="btn-clear" onclick="clearHoursInModal('${activityId}')">Wis</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function changeHoursInModal(inputId, change) {
            const input = document.getElementById(inputId);
            const currentValue = parseFloat(input.value) || 0;
            const newValue = Math.max(0, Math.min(12, currentValue + change));
            input.value = newValue;
            updateTotalOverviewInModal();
        }

        function setFullDayInModal(inputId) {
            clearAllHoursInModal();
            
            // Determine hours based on day of week
            const dayOfWeek = selectedDate.getDay(); // 0 = Sunday, 1 = Monday, ..., 5 = Friday
            let hours;
            
            if (dayOfWeek === 5) { // Friday
                hours = '8';
            } else if (dayOfWeek >= 1 && dayOfWeek <= 4) { // Monday to Thursday
                hours = '7.5';
            } else {
                // Weekend (shouldn't happen in this app, but default to 7.5)
                hours = '7.5';
            }
            
            document.getElementById(inputId).value = hours;
            updateTotalOverviewInModal();
        }

        function clearHoursInModal(inputId) {
            document.getElementById(inputId).value = '0';
            updateTotalOverviewInModal();
        }

        function clearAllHoursInModal() {
            if (!currentWorkLine) return;
            
            const activities = workLines[currentWorkLine].activities;
            activities.forEach(activity => {
                const inputId = 'modal-' + activity.toLowerCase().replace(/[^a-z0-9]/g, '') + '-hours';
                const input = document.getElementById(inputId);
                if (input) {
                    input.value = '0';
                }
            });
        }

        function updateWorklineButtonsWithExistingHours() {
            document.querySelectorAll('#modal-workline-grid .workline-btn').forEach(btn => {
                btn.classList.remove('selected', 'has-hours');
                
                const workLineKey = btn.onclick.toString().match(/'([^']+)'/)[1];
                if (multiWorkLineData[workLineKey] && Object.keys(multiWorkLineData[workLineKey]).length > 0) {
                    const hoursForWorkLine = Object.values(multiWorkLineData[workLineKey]).reduce((sum, hours) => sum + hours, 0);
                    btn.classList.add('has-hours');
                    btn.innerHTML = `${workLines[workLineKey].name}<br><small>(${hoursForWorkLine.toFixed(2)}u)</small>`;
                } else {
                    btn.textContent = workLines[workLineKey].name;
                }
            });
        }

        function saveRegistrationFromModal() {
    if (!currentEmployee) {
        showStatus('Geen werknemer geselecteerd', 'error');
        return;
    }
    
    saveCurrentWorkLineDataInModal();
    
    if (Object.keys(multiWorkLineData).length === 0) {
        showStatus('Voer minimaal één activiteit in', 'error');
        return;
    }
            // Nieuwe controle voor Overig beschrijving
for (let workLineKey in multiWorkLineData) {
    for (let activity in multiWorkLineData[workLineKey]) {
        if (activity === 'Overig') {
            showStatus('Bij Overig moet je een beschrijving invullen van minimaal 5 tekens', 'error');
            return;
        }
        if (activity.startsWith('Overig: ')) {
            const beschrijving = activity.substring(8).trim(); // Tekst na "Overig: "
            if (beschrijving.length < 4) {
                showModalStatus('Vul beschrijving Overig in', 'error');
                return;
            }
        }
    }
}

    let totalHours = 0;
    const workLineNames = [];
    
    Object.entries(multiWorkLineData).forEach(([workLineKey, activities]) => {
        workLineNames.push(workLines[workLineKey].name);
        Object.values(activities).forEach(hours => {
            totalHours += hours;
        });
    });
    
    const selectedDateString = selectedDate.getFullYear() + '-' + 
        String(selectedDate.getMonth() + 1).padStart(2, '0') + '-' + 
        String(selectedDate.getDate()).padStart(2, '0');
    const currentTime = new Date().toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
    
    registrations = registrations.filter(reg => 
        !(reg.employee === currentEmployee && reg.date === selectedDateString)
    );
    
    const registration = {
        employee: currentEmployee,
        workLineNames: workLineNames,
        date: selectedDateString,
        time: currentTime,
        hours: multiWorkLineData,
        total: totalHours
    };
    
    registrations.unshift(registration);
    localStorage.setItem('sousvide_registrations', JSON.stringify(registrations));
    
    // Increment registration counter for auto-upload tracking
    registrationCounter++;
    
    const employeeName = currentEmployee;
    const dateText = selectedDate.toLocaleDateString('nl-NL');
    
    closeHoursModal();
    
    if (planningData.length > 0) {
        displayPlanningTable();
    }
    
    showStatus(`✅ Uren bijgewerkt voor ${employeeName} op ${dateText} (${totalHours.toFixed(2)}u totaal)!`, 'success');

            function showModalStatus(message, type) {
    // Verwijder bestaande modal status
    const existingStatus = document.querySelector('.modal-status');
    if (existingStatus) {
        existingStatus.remove();
    }
    
    // Maak nieuwe modal status
    const modalContent = document.querySelector('.hours-modal-content');
    const statusEl = document.createElement('div');
    statusEl.className = `modal-status ${type}`;
    statusEl.textContent = message;
    modalContent.appendChild(statusEl);
    
    // Verwijder na 5 seconden
    setTimeout(() => {
        statusEl.remove();
    }, 5000);
}
    
    // Check if we need to auto-upload after 10 registrations
    if (registrationCounter >= UPLOAD_TRIGGER_COUNT && account) {
        showUploadIndicator(`Auto-upload na ${UPLOAD_TRIGGER_COUNT} registraties...`, 'uploading');
        setTimeout(async () => {
            await sendDataReliable();
            registrationCounter = 0; // Reset counter after successful upload
        }, 1000);
    } else if (registrationCounter >= UPLOAD_TRIGGER_COUNT && !account) {
        showUploadIndicator('Log in om auto-upload te activeren', 'error');
    }
}
        // Auto-upload functionality for reliability
        let uploadQueue = [];
        let isUploading = false;
        let lastUploadAttempt = null;

        // Check for unsent data and auto-upload periodically
        function initializeAutoUpload() {
            // Try to upload every 10 minutes
            setInterval(checkAndAutoUpload, 10 * 60 * 1000);
            
            // Also check on page load
            setTimeout(checkAndAutoUpload, 5000); // Wait 5 seconds after load
            
            // Upload before page unload
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsentData()) {
                    sendDataReliable();
                    e.preventDefault();
                    e.returnValue = 'Er zijn nog niet-verstuurde gegevens. Weet je zeker dat je de pagina wilt verlaten?';
                    return e.returnValue;
                }
            });
        }

        function hasUnsentData() {
            if (!registrations || registrations.length === 0) return false;
            
            // Check if we have data from today that hasn't been uploaded recently
            const today = new Date().toISOString().split('T')[0];
            const hasDataFromToday = registrations.some(reg => reg.date === today);
            
            if (!hasDataFromToday) return false;
            
            // Check last upload time
            const lastUpload = localStorage.getItem('last_successful_upload');
            if (!lastUpload) return true;
            
            const lastUploadTime = new Date(lastUpload);
            const now = new Date();
            const hoursSinceUpload = (now - lastUploadTime) / (1000 * 60 * 60);
            
            // If more than 4 hours since last upload and we have today's data, consider unsent
            return hoursSinceUpload > 4;
        }

        async function checkAndAutoUpload() {
            if (isUploading) return;
            
            if (!account) {
                console.log('Auto-upload skipped: not logged in');
                return;
            }
            
            if (hasUnsentData()) {
                console.log('Auto-upload triggered: unsent data detected');
                showUploadIndicator('Periodieke auto-upload...', 'uploading');
                await sendDataReliable();
            }
        }

        async function sendDataReliable() {
            if (isUploading) {
                showStatus('Upload al bezig...', 'error');
                return;
            }
            
            if (!registrations || registrations.length === 0) {
                showStatus('Geen data om te versturen', 'error');
                return;
            }

            if (!account) {
                showStatus('Log eerst in bij Microsoft om gegevens te versturen', 'error');
                showUploadIndicator('Niet ingelogd - kan niet uploaden', 'error');
                return;
            }

            isUploading = true;
            let attempt = 1;
            const maxAttempts = 5;
            
            while (attempt <= maxAttempts) {
                try {
                    showUploadIndicator(`Uploaden... (${attempt}/${maxAttempts})`, 'uploading');

                    // Get access token with retry logic
                    let tokenResponse;
                    try {
                        const tokenRequest = {
                            scopes: ['Files.ReadWrite'],
                            account: account
                        };
                        tokenResponse = await msalInstance.acquireTokenSilent(tokenRequest);
                    } catch (tokenError) {
    if (tokenError.message.includes('interaction_required')) {
        const tokenRequest = {
            scopes: ['Files.ReadWrite'],
            account: account
        };
        tokenResponse = await msalInstance.acquireTokenPopup(tokenRequest);
    } else {
        throw tokenError;
    }
}

                    const accessToken = tokenResponse.accessToken;

                    // Filter voor registraties die nog niet ge-upload zijn
const lastUpload = localStorage.getItem('last_successful_upload');
let unsentRegistrations;

if (lastUpload) {
    const lastUploadTime = new Date(lastUpload);
    unsentRegistrations = registrations.filter(reg => {
        const regTime = new Date(reg.date + 'T' + (reg.time || '00:00') + ':00');
        return regTime > lastUploadTime;
    });
} else {
    // Als er nog nooit ge-upload is, alle registraties meenemen
    unsentRegistrations = registrations;
}

if (unsentRegistrations.length === 0) {
    showUploadIndicator('Geen nieuwe data om te uploaden', 'success');
    isUploading = false;
    return;
}

// Prepare CSV data
let csvContent = 'Werknemer;Afdeling;Datum;Activiteit;Uren\n';

unsentRegistrations.forEach(reg => {
    if (reg.hours && typeof reg.hours === 'object') {
        if (reg.workLineNames && !Array.isArray(reg.hours)) {
            Object.entries(reg.hours).forEach(([workLineKey, activities]) => {
                const workLineName = workLines[workLineKey] ? workLines[workLineKey].name : workLineKey;
                Object.entries(activities).forEach(([activity, hours]) => {
                    csvContent += `${reg.employee || 'Onbekend'};${workLineName};${reg.date || 'Onbekend'};${activity};${hours.toString().replace('.', ',')}\n`;
                });
            });
        } else {
            Object.entries(reg.hours).forEach(([activity, hours]) => {
                csvContent += `${reg.employee || 'Onbekend'};${reg.workLineName || 'Onbekend'};${reg.date || 'Onbekend'};${activity};${hours.toString().replace('.', ',')}\n`;
            });
        }
    }
});

                    // Create filename with timestamp
                    const now = new Date();
                    const timestamp = `${now.toISOString().split('T')[0]}_${now.toTimeString().slice(0,5).replace(':', '')}`;
                    const filename = `tijdregistratie_${timestamp}.csv`;

                    // Upload to OneDrive with timeout
                    const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/Autouploads/${filename}:/content`;
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                    
                    const uploadResponse = await fetch(uploadUrl, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'text/csv'
                        },
                        body: csvContent,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (uploadResponse.ok) {
                        const result = await uploadResponse.json();
                        
                        // Mark as successfully uploaded
                        localStorage.setItem('last_successful_upload', now.toISOString());
                        localStorage.setItem('last_upload_filename', filename);
                        
                        showUploadIndicator(`✅ Upload succesvol: ${filename}`, 'success');
                        showStatus(`✅ Gegevens succesvol verstuurd naar OneDrive/Autouploads als ${filename}`, 'success');
                        isUploading = false;
                        return; // Success, exit retry loop
                        
                    } else {
                        throw new Error(`Upload failed: ${uploadResponse.status} ${uploadResponse.statusText}`);
                    }

                } catch (error) {
                    console.error(`Upload attempt ${attempt} failed:`, error);
                    
                    if (attempt === maxAttempts) {
                        // Final attempt failed
                        showUploadIndicator('❌ Upload mislukt na meerdere pogingen', 'error');
                        showStatus(`❌ Upload mislukt na ${maxAttempts} pogingen. Probeer later opnieuw of controleer internetverbinding.`, 'error');
                        
                        // Store failed attempt info
                        localStorage.setItem('last_failed_upload', new Date().toISOString());
                        localStorage.setItem('failed_upload_data', JSON.stringify(registrations));
                        
                        isUploading = false;
                        return;
                    }
                    
                    // Wait before retry (exponential backoff)
                    const waitTime = Math.min(1000 * Math.pow(2, attempt), 30000); // Max 30 seconds
                    showUploadIndicator(`Opnieuw proberen in ${Math.round(waitTime/1000)}s...`, 'uploading');
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                    
                    attempt++;
                }
            }
            
            isUploading = false;
        }

        // Replace the old sendData function
        async function sendData() {
            await sendDataReliable();
        }

        function downloadCSV() {
    if (!registrations || registrations.length === 0) {
        showStatus('Geen data om te downloaden', 'error');
        return;
    }
    
    // Filter voor registraties die nog niet ge-upload zijn
    const lastUpload = localStorage.getItem('last_successful_upload');
    let unsentRegistrations;
    
    if (lastUpload) {
        const lastUploadTime = new Date(lastUpload);
        unsentRegistrations = registrations.filter(reg => {
            const regTime = new Date(reg.date + 'T' + (reg.time || '00:00') + ':00');
            return regTime > lastUploadTime;
        });
    } else {
        // Als er nog nooit ge-upload is, alle registraties meenemen
        unsentRegistrations = registrations;
    }
    
    if (unsentRegistrations.length === 0) {
        showStatus('Geen niet-verstuurde data om te downloaden', 'error');
        return;
    }
    
    let csvContent = 'Werknemer;Afdeling;Datum;Activiteit;Uren\n';
    
    unsentRegistrations.forEach(reg => {
        if (reg.hours && typeof reg.hours === 'object') {
            if (reg.workLineNames && typeof reg.hours === 'object' && !Array.isArray(reg.hours)) {
                Object.entries(reg.hours).forEach(([workLineKey, activities]) => {
                    const workLineName = workLines[workLineKey] ? workLines[workLineKey].name : workLineKey;
                    Object.entries(activities).forEach(([activity, hours]) => {
                        csvContent += `${reg.employee || 'Onbekend'};${workLineName};${reg.date || 'Onbekend'};${activity};${hours.toString().replace('.', ',')}\n`;
                    });
                });
            } else {
                Object.entries(reg.hours).forEach(([activity, hours]) => {
                    csvContent += `${reg.employee || 'Onbekend'};${reg.workLineName || 'Onbekend'};${reg.date || 'Onbekend'};${activity};${hours.toString().replace('.', ',')}\n`;
                });
            }
        }
    });
    
    if (csvContent === 'Werknemer;Afdeling;Datum;Activiteit;Uren\n') {
        showStatus('Geen geldige data om te downloaden', 'error');
        return;
    }
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    const now = new Date();
    const timestamp = `${now.toISOString().split('T')[0]}_${now.toTimeString().slice(0,5).replace(':', '')}`;
    link.setAttribute('href', url);
    link.setAttribute('download', `tijdregistratie_${timestamp}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showStatus(`CSV gedownload met ${unsentRegistrations.length} niet-verstuurde registraties!`, 'success');
}
        function loadData() {
            try {
                const savedData = localStorage.getItem('sousvide_registrations');
                if (savedData) {
                    registrations = JSON.parse(savedData);
                    if (!Array.isArray(registrations)) {
                        registrations = [];
                    }
                }

                // Load registration counter
                const savedCounter = localStorage.getItem('registration_counter');
                if (savedCounter) {
                    registrationCounter = parseInt(savedCounter, 10) || 0;
                }
            } catch (error) {
                registrations = [];
                registrationCounter = 0;
                localStorage.removeItem('sousvide_registrations');
                localStorage.removeItem('registration_counter');
            }
        }

        function saveRegistrationCounter() {
            localStorage.setItem('registration_counter', registrationCounter.toString());
        }

        async function signInToMicrosoft() {
            try {
                if (!msalInstance) {
                    msalInstance = new msal.PublicClientApplication(msalConfig);
                    await msalInstance.initialize();
                }

                showStatus('Inloggen bij Microsoft...', 'success');
                
                const loginResponse = await msalInstance.loginPopup(loginRequest);
                account = loginResponse.account;
                
                // Update UI
                document.getElementById('sign-in-btn').style.display = 'none';
                document.getElementById('sign-out-btn').style.display = 'block';
                document.getElementById('user-info').textContent = account.name || account.username;
                document.getElementById('user-info').style.display = 'block';
                
                showStatus(`Welkom ${account.name || account.username}!`, 'success');
                showUploadIndicator('Auto-upload geactiveerd', 'success');
                
                // Check for unsent data after login and upload if needed
                setTimeout(async () => {
                    if (hasUnsentData() || registrationCounter > 0) {
                        showUploadIndicator('Uploaden van bestaande gegevens...', 'uploading');
                        await sendDataReliable();
                        registrationCounter = 0;
                        saveRegistrationCounter();
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Login failed:', error);
                showStatus('Inloggen mislukt. Probeer opnieuw.', 'error');
                showUploadIndicator('Inloggen mislukt', 'error');
            }
        }

        function signOut() {
            try {
                if (msalInstance && account) {
                    msalInstance.logoutPopup({
                        account: account
                    });
                }
                
                // Reset UI
                document.getElementById('sign-in-btn').style.display = 'block';
                document.getElementById('sign-out-btn').style.display = 'none';
                document.getElementById('user-info').style.display = 'none';
                account = null;
                
                showStatus('Uitgelogd', 'success');
                showUploadIndicator('Auto-upload gedeactiveerd', 'error');
                
            } catch (error) {
                console.error('Logout failed:', error);
                showStatus('Uitloggen mislukt', 'error');
            }
        }

        // Check if user is already logged in on page load
        async function checkExistingLogin() {
            try {
                if (!msalInstance) {
                    msalInstance = new msal.PublicClientApplication(msalConfig);
                    await msalInstance.initialize();
                }
                
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    account = accounts[0];
                    
                    // Update UI for logged in state
                    document.getElementById('sign-in-btn').style.display = 'none';
                    document.getElementById('sign-out-btn').style.display = 'block';
                    document.getElementById('user-info').textContent = account.name || account.username;
                    document.getElementById('user-info').style.display = 'block';
                    
                    showUploadIndicator('Auto-upload actief', 'success');
                }
            } catch (error) {
                console.error('Error checking existing login:', error);
            }
        }

        window.onclick = function(event) {
            const hoursModal = document.getElementById('hours-modal');
            
            if (event.target === hoursModal) {
                closeHoursModal();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeDates();
            loadData();
            checkExistingLogin(); // Check if user is already logged in
            initializeAutoUpload(); // Initialize bullet-proof upload system
            
            // Show registration counter status if there are pending registrations
            if (registrationCounter > 0) {
                showUploadIndicator(`${registrationCounter}/${UPLOAD_TRIGGER_COUNT} registraties tot auto-upload`, 'uploading');
            }
        });

        // Save registration counter periodically
        setInterval(saveRegistrationCounter, 30000); // Save every 30 seconds
    </script>
</body>
</html>
            
