<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tijdregistratie</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f0f2f5;
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            max-width: 95vw; /* Gebruik bijna de volledige scherm breedte */
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            margin: 0;
            color: #1a1a1a;
            font-size: 2.4em;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        #auth-buttons {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Zorg ervoor dat ALLE secties dezelfde styling hebben */
        .section {
            margin-bottom: 30px;
            width: 100%; /* Expliciete breedte */
        }

        .section h2 {
            color: #343a40;
            margin-bottom: 18px;
            font-size: 1.6em;
            font-weight: 600;
        }

        /* Uniforme knoppen voor beheer opties */
        .btn-uniform {
            background: #6c757d;
            color: white;
            padding: 16px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.2s;
            min-height: 50px;
            min-width: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-uniform:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-uniform.btn-yellow {
            background: #fed500;
            color: #1a1a1a;
            box-shadow: 0 2px 8px rgba(254,213,0,0.3);
        }

        .btn-uniform.btn-yellow:hover {
            background: #e6c200;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(254,213,0,0.4);
        }

        .btn-auth {
            background: #fed500;
            color: #1a1a1a;
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.2s;
            min-height: 48px;
            box-shadow: 0 2px 8px rgba(254,213,0,0.3);
        }

        .btn-auth:hover {
            background: #e6c200;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(254,213,0,0.4);
        }

        .btn-auth.sign-out {
            background: #dc3545;
        }

        .btn-auth.sign-out:hover {
            background: #c82333;
        }

        .user-info {
            color: #333;
            font-size: 1.1em;
            margin-right: 20px;
            font-weight: 600;
            background: #f8f9fa;
            padding: 12px 18px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            white-space: nowrap;
        }

        /* UNIFORME SECTIE STYLING - alle secties gebruiken deze class */
        .planning-section,
        .data-overview {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #dee2e6;
            width: 100%; /* Zorgt voor consistente breedte */
            box-sizing: border-box; /* Include padding en border in width */
        }

        .planning-section h3,
        .data-overview h3 {
            margin-bottom: 20px;
            color: #495057;
            font-size: 1.4em;
            font-weight: 600;
        }

        .file-input {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            font-size: 1.1em;
            min-width: 250px;
            margin-right: 15px;
        }

        .planning-filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .planning-filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .planning-filter-label {
            font-weight: 600;
            color: #495057;
            font-size: 1.1em;
        }

        .planning-filter-select {
            background: #0063ac;
            color: white;
            padding: 18px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 200px;
            min-height: 60px;
        }

        .planning-filter-select:hover {
            background: #004a85;
            transform: translateY(-1px);
        }

        .planning-filter-select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,99,172,0.3);
        }

        .planning-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            font-size: 1.1em;
            border: 2px solid #dee2e6;
        }

        .planning-table th,
        .planning-table td {
            padding: 15px 12px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
        }

        .planning-table th {
            background: #0063ac;
            color: white;
            font-weight: 600;
            font-size: 1.2em;
        }

        .planning-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .planning-table tr:hover {
            background: #e9ecef;
        }

        .planning-table tr:last-child td {
            border-bottom: none;
        }

        .planning-table td:last-child,
        .planning-table th:last-child {
            border-right: none;
        }

        .planning-table th.werkelijk-header {
            background: #28a745 !important;
        }

        .planning-table td.werkelijk-cell {
            background: #d4edda;
            font-weight: 600;
            color: #155724;
        }

        .planning-table td.werkelijk-cell.empty {
            background: #f8f9fa;
            color: #6c757d;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            width: 95%;
            max-width: 1200px;
            height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: #1a1a1a;
            font-size: 1.8em;
            font-weight: 600;
        }

        .btn-close {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.6em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-close:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        /* TABLET OPTIMIZED GRIDS */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 12px;
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            background: #f8f9fa;
            width: 100%; /* Voeg expliciete breedte toe */
            box-sizing: border-box;
        }

        .workline-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            background: #f8f9fa;
            width: 100%; /* Voeg expliciete breedte toe */
            box-sizing: border-box;
        }

        .employee-btn {
            padding: 18px 12px;
            background: #0063ac;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .employee-btn:hover {
            background: #004a85;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,99,172,0.3);
        }

        .employee-btn:active {
            transform: translateY(0);
        }

        .employee-btn.selected {
            background: #fed500;
            color: #1a1a1a;
            box-shadow: 0 4px 15px rgba(254,213,0,0.4);
            font-weight: 600;
        }

        .workline-btn {
            padding: 24px 20px;
            background: #0063ac;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .workline-btn:hover {
            background: #004a85;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,99,172,0.3);
        }

        .workline-btn.selected {
            background: #fed500;
            color: #1a1a1a;
            box-shadow: 0 6px 25px rgba(254,213,0,0.4);
        }

        .add-employee-row {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 30px;
        }

        .employee-input {
            flex: 1;
            padding: 18px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1.2em;
            min-height: 56px;
        }

        .employee-input:focus {
            outline: none;
            border-color: #0063ac;
            box-shadow: 0 0 0 3px rgba(0,99,172,0.1);
        }

        .btn-add {
            background: #0063ac;
            color: white;
            padding: 18px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 500;
            min-height: 56px;
            transition: all 0.2s;
        }

        .btn-add:hover {
            background: #004a85;
            transform: translateY(-1px);
        }

        .employee-list {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            background: white;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
        }

        .employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            font-size: 1.2em;
        }

        .employee-item:last-child {
            border-bottom: none;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 18px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            min-height: 40px;
            transition: all 0.2s;
        }

        .btn-remove:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        /* TABLET OPTIMIZED TABLE */
        .activities-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 25px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            overflow: hidden;
            background: white;
        }

        .activities-table th,
        .activities-table td {
            padding: 20px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            font-size: 1.3em;
        }

        .activities-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 1.4em;
        }

        .activities-table tr:hover {
            background: #f8f9fa;
        }

        .activities-table tr:last-child td {
            border-bottom: none;
        }

        /* TABLET OPTIMIZED HOUR CONTROLS */
        .hour-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            justify-content: flex-start;
            width: 100%;
            flex-wrap: wrap;
        }

        .hour-buttons-group {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .hour-btn {
            width: 75px;
            height: 65px;
            border: 2px solid #dee2e6;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        .hour-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            transform: translateY(-1px);
        }

        .hour-btn:active {
            transform: scale(0.95);
        }

        .hour-btn.minus {
            color: #dc3545;
            border-color: #dc3545;
        }

        .hour-btn.minus:hover {
            background: #dc3545;
            color: white;
        }

        .hour-btn.plus {
            color: #0063ac;
            border-color: #0063ac;
        }

        .hour-btn.plus:hover {
            background: #0063ac;
            color: white;
        }

        .hour-input {
            width: 105px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            text-align: center;
            font-size: 1.3em;
            font-weight: 600;
            background: #fff;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            min-height: 65px;
        }

        .hour-input:focus {
            outline: none;
            border-color: #0063ac;
            box-shadow: 0 0 0 3px rgba(0,99,172,0.1);
        }

        .hour-input::-webkit-outer-spin-button,
        .hour-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .controls {
            text-align: center;
            margin-top: 30px;
            width: 100%; /* Zorgt voor consistente breedte */
        }

        .btn {
            padding: 15px 35px;
            margin: 0 12px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 56px;
        }

        .btn-primary {
            background: #0063ac;
            color: white;
            padding: 22px 60px;
            font-size: 1.5em;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #004a85;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,99,172,0.3);
        }

        .btn-secondary {
            background: #f44336;
            color: white;
        }

        .btn-secondary:hover {
            background: #da190b;
            transform: translateY(-1px);
        }

        .btn-download {
            background: #FF9800;
            color: white;
        }

        .btn-download:hover {
            background: #F57C00;
            transform: translateY(-1px);
        }

        .btn-clear {
            background: #dc3545;
            color: white;
            padding: 10px 18px;
            font-size: 1em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 8px;
            min-height: 44px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-clear:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .btn-fullday {
            background: #FF9800;
            color: white;
            padding: 10px 18px;
            font-size: 1em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            min-height: 44px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-fullday:hover {
            background: #F57C00;
            transform: translateY(-1px);
        }

        .selected-employee {
            background: linear-gradient(135deg, #e8f4fd, #d1ecf1);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.3em;
            color: #0063ac;
            font-weight: 600;
            border: 2px solid #0063ac;
        }

        .hidden {
            display: none;
        }

        .status {
            text-align: center;
            padding: 18px;
            margin: 25px 0;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        /* DEPARTMENTS ROW - fix voor gelijke breedte */
        .departments-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
            width: 100%; /* Expliciete breedte */
            box-sizing: border-box;
        }

        .department-overview {
            margin-bottom: 0;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            width: 100%; /* Zorgt voor gelijke breedte */
            box-sizing: border-box;
        }

        .department-overview h4 {
            background: #0063ac;
            color: white;
            margin: 0;
            padding: 15px 20px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .department-overview pre {
            background: #fff;
            padding: 20px;
            margin: 0;
            border-radius: 0;
            font-size: 0.95em;
            overflow-x: auto;
            max-height: 180px;
            overflow-y: auto;
            min-height: 80px;
            line-height: 1.4;
        }

        .total-hours {
            font-weight: 600;
            color: #0063ac;
            font-size: 1.2em;
        }

        .quick-fill {
            display: flex;
            gap: 12px;
            margin-bottom: 18px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 10px 18px;
            background: #e9ecef;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.2s;
            min-height: 44px;
        }

        .quick-btn:hover {
            background: #adb5bd;
            transform: translateY(-1px);
        }

        /* TABLET OPTIMIZED TOTAL OVERVIEW */
        .total-overview {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
            border: 2px solid #dee2e6;
            width: 100%; /* Expliciete breedte */
            box-sizing: border-box;
        }

        .workline-totals {
            display: flex;
            justify-content: flex-start;
            gap: 18px;
            flex-wrap: wrap;
        }

        .workline-total {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid #1976d2;
            min-width: 140px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .workline-total .name {
            font-weight: 600;
            color: #1565c0;
            font-size: 1em;
            margin-bottom: 5px;
        }

        .workline-total .hours {
            font-size: 1.4em;
            color: #0d47a1;
            font-weight: 700;
        }

        .grand-total {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border: 2px solid #4caf50;
            padding: 15px 20px;
            border-radius: 10px;
            min-width: 160px;
            box-shadow: 0 4px 12px rgba(76,175,80,0.2);
        }

        .grand-total .name {
            font-weight: 600;
            color: #2e7d32;
            font-size: 1em;
            margin-bottom: 5px;
        }

        .grand-total .hours {
            font-size: 1.4em;
            color: #1b5e20;
            font-weight: 700;
        }

        .grand-total.warning {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border-color: #f44336;
            box-shadow: 0 4px 12px rgba(244,67,54,0.2);
        }

        .grand-total.warning .name {
            color: #c62828;
        }

        .grand-total.warning .hours {
            color: #b71c1c;
        }

        /* Responsive improvements voor kleinere tablets */
        @media (max-width: 1100px) {
            .employee-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 10px;
            }
        }
        
        @media (max-width: 900px) {
            .employee-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
            }
            
            .user-info {
                font-size: 1em;
                padding: 10px 14px;
                margin-right: 15px;
            }
            
            .departments-row {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .hour-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .hour-buttons-group {
                justify-content: center;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header-buttons {
                justify-content: center;
            }
        }

        @media (max-width: 600px) {
            .employee-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .departments-row {
                grid-template-columns: 1fr;
            }
        }

        /* Styling voor alle registraties overzicht */
        .all-registrations-overview {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            overflow: hidden;
            width: 100%; /* Expliciete breedte */
            box-sizing: border-box;
        }

        .all-registrations-overview pre {
            background: #fff;
            padding: 20px;
            margin: 0;
            border-radius: 0;
            font-size: 0.9em;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
            min-height: 100px;
            line-height: 1.4;
        }

        /* Touch-friendly improvements */
        @media (hover: none) {
            .employee-btn:hover,
            .workline-btn:hover,
            .hour-btn:hover,
            .btn:hover,
            .btn-primary:hover {
                transform: none;
                box-shadow: none;
            }
        }

        /* Overig description input styling */
        .overig-description {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1.3em;
            background: #fff;
        }

        .overig-description:focus {
            outline: none;
            border-color: #0063ac;
            box-shadow: 0 0 0 3px rgba(0,99,172,0.1);
        }

        /* EXTRA FIX: Zorg dat inline styles niet overrulen */
        #workline-grid {
            width: 100% !important;
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Tijdregistratie</h1>
            <div class="header-buttons">
                <div id="auth-buttons">
                    <span id="user-info" class="user-info"></span>
                    <button id="sign-in-btn" class="btn-auth" onclick="signInToMicrosoft()">
                        Inloggen Microsoft
                    </button>
                    <button id="sign-out-btn" class="btn-auth sign-out" onclick="signOut()" style="display: none;">
                        Uitloggen
                    </button>
                </div>
            </div>
        </div>

        <!-- Personeelsplanning sectie -->
        <div class="section">
            <div class="planning-section">
                <h3>📅 Personeelsplanning</h3>
                <input type="file" id="planning-file" class="file-input" accept=".csv" onchange="loadPlanningCSV(event)">
                <button class="btn-uniform" onclick="clearPlanning()">Wis planning</button>
                
                <div id="planning-display" style="display: none;">
                    <div style="margin: 20px 0;">
                        <div style="font-weight: bold; color: #495057; font-size: 1.3em; margin-bottom: 20px;">
                            <span id="planning-info"></span>
                        </div>
                        
                        <!-- Filters -->
                        <div class="planning-filters">
                            <div class="planning-filter-group">
                                <label class="planning-filter-label">Ploeg:</label>
                                <select id="ploeg-filter" class="planning-filter-select" onchange="filterPlanning()">
                                    <option value="">Alle ploegen</option>
                                </select>
                            </div>
                            
                            <div class="planning-filter-group">
                                <label class="planning-filter-label">Afdeling:</label>
                                <select id="afdeling-filter" class="planning-filter-select" onchange="filterPlanning()">
                                    <option value="">Alle afdelingen</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- VOLLEDIG SCHERMVULLEND WRAPPER -->
                    <div class="planning-table-wrapper">
                        <table class="planning-table" id="planning-table">
                            <thead id="planning-head"></thead>
                            <tbody id="planning-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal voor werknemersbeheer -->
        <div class="modal" id="employee-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Beheer werknemers</h2>
                    <button class="btn-close" onclick="closeEmployeeModal()">&times;</button>
                </div>
                
                <div class="add-employee-row">
                    <input type="text" id="new-employee-name" class="employee-input" placeholder="Nieuwe werknemer naam...">
                    <button class="btn-add" onclick="addEmployee()">Toevoegen</button>
                </div>
                
                <div class="employee-list" id="employee-list">
                    <!-- Wordt dynamisch gevuld -->
                </div>
            </div>
        </div>
        
        <!-- Stap 1: Werknemer selecteren -->
        <div class="section" id="employee-selection">
            <h2>1. Kies werknemer:</h2>
            <div class="employee-grid" id="employee-grid">
                <!-- Wordt dynamisch gevuld -->
            </div>
        </div>

        <!-- Stap 2: Werklijn selecteren -->
        <div class="section hidden" id="workline-selection">
            <h2>2. Kies afdeling:</h2>
            <div id="workline-grid" class="workline-grid">
                <button class="workline-btn" onclick="selectWorkLine('schillijn')">Schillijn</button>
                <button class="workline-btn" onclick="selectWorkLine('inpakken')">Inpakken</button>
                <button class="workline-btn" onclick="selectWorkLine('sousvide')">Sous-vide</button>
                <button class="workline-btn" onclick="selectWorkLine('koelcel')">Koelcel</button>
                <button class="workline-btn" onclick="selectWorkLine('fusthal')">Fusthal</button>
                <button class="workline-btn" onclick="selectWorkLine('puree')">Puree</button>
            </div>
        </div>

        <!-- Totaal overzicht van alle werklijnen -->
        <div class="total-overview hidden" id="total-overview">
            <div class="workline-totals" id="workline-totals">
                <!-- Wordt dynamisch gevuld -->
            </div>
        </div>

        <!-- Stap 3: Urenregistratie -->
        <div class="section hidden" id="hours-registration">
            <h2>3. Voer aantal uren per activiteit in:</h2>
            
            <table class="activities-table">
                <thead>
                    <tr>
                        <th>Activiteit</th>
                        <th style="text-align: center;">Aantal uren</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="activities-tbody">
                    <!-- Wordt dynamisch gevuld op basis van gekozen werklijn -->
                </tbody>
            </table>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="saveRegistration()">Opslaan</button>
            </div>
        </div>

        <!-- Status berichten -->
        <div id="status-message"></div>

        <!-- Data overzicht en download -->
        <div class="section">
            <div class="data-overview">
                <h3>Uren per afdeling:</h3>
                
                <div class="departments-row">
                    <!-- Schillijn -->
                    <div class="department-overview">
                        <h4>Schillijn</h4>
                        <pre id="schillijn-preview">Nog geen registraties</pre>
                    </div>
                    
                    <!-- Inpakken -->
                    <div class="department-overview">
                        <h4>Inpakken</h4>
                        <pre id="inpakken-preview">Nog geen registraties</pre>
                    </div>

                    <!-- Sous-vide -->
                    <div class="department-overview">
                        <h4>Sous-vide</h4>
                        <pre id="sousvide-preview">Nog geen registraties</pre>
                    </div>
                </div>
                
                <div class="departments-row">
                    <!-- Koelcel -->
                    <div class="department-overview">
                        <h4>Koelcel</h4>
                        <pre id="koelcel-preview">Nog geen registraties</pre>
                    </div>
                    
                    <!-- Fusthal -->
                    <div class="department-overview">
                        <h4>Fusthal</h4>
                        <pre id="fusthal-preview">Nog geen registraties</pre>
                    </div>
                    
                    <!-- Puree -->
                    <div class="department-overview">
                        <h4>Puree</h4>
                        <pre id="puree-preview">Nog geen registraties</pre>
                    </div>
                </div>

                <!-- Werknemers totalen -->
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px; color: #495057; font-size: 1.4em; font-weight: 600;">
                        Uren per werknemer (vandaag):
                    </h3>
                    <div class="all-registrations-overview">
                        <pre id="employee-totals-preview">Nog geen registraties</pre>
                    </div>
                </div>
            </div>
            
            <div class="controls" style="display: flex; justify-content: center;">
                <button class="btn-uniform btn-yellow" onclick="toggleDataManagement()">Beheer opties</button>
            </div>
            
            <div class="hidden" id="data-management">
                <div class="controls" style="margin-top: 15px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn-uniform" onclick="openEmployeeModal()">Beheer werknemers</button>
                    <button id="send-data-btn" class="btn-uniform" onclick="sendData()">Gegevens versturen</button>
                    <button class="btn-uniform" onclick="downloadCSV()">Download alle CSV</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://alcdn.msauth.net/browser/2.32.2/js/msal-browser.min.js"></script>
    <script>
        // Personeelsplanning variabelen
        let planningData = [];
        let allPlanningData = []; // Bewaar originele data voor filtering
        let planningHeader = [];

        // Personeelsplanning functies
        function loadPlanningCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showStatus('CSV bestand laden...', 'success');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                let csv = e.target.result;
                
                // Verwijder UTF-8 BOM als deze er is
                if (csv.charCodeAt(0) === 0xFEFF) {
                    csv = csv.slice(1);
                    console.log('UTF-8 BOM verwijderd');
                }
                
                parsePlanningCSV(csv);
            };
            
            // Probeer eerst UTF-8, dan andere encodings
            reader.readAsText(file, 'UTF-8');
        }
        
        function parsePlanningCSV(csvText) {
            try {
                console.log('=== CSV PARSING DEBUG ===');
                console.log('Originele CSV lengte:', csvText.length);
                console.log('Eerste 200 karakters:', csvText.substring(0, 200));
                console.log('Char codes eerste regel:', csvText.substring(0, 50).split('').map(c => c.charCodeAt(0)));
                
                // Normaliseer line endings en trim
                csvText = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
                
                const lines = csvText.split('\n');
                console.log('Aantal regels na split:', lines.length);
                console.log('Eerste regel:', JSON.stringify(lines[0]));
                
                if (lines.length < 1) {
                    showStatus('CSV bestand is leeg', 'error');
                    return;
                }
                
                // Test verschillende delimiters met de eerste regel
                const firstLine = lines[0];
                let delimiter = ';';
                let header = [];
                
                // Test puntkomma
                let testHeader = firstLine.split(';').map(h => h.trim());
                console.log('Test met ; (', testHeader.length, 'kolommen):', testHeader);
                
                if (testHeader.length > 1) {
                    delimiter = ';';
                    header = testHeader;
                } else {
                    // Test comma
                    testHeader = firstLine.split(',').map(h => h.trim());
                    console.log('Test met , (', testHeader.length, 'kolommen):', testHeader);
                    
                    if (testHeader.length > 1) {
                        delimiter = ',';
                        header = testHeader;
                    } else {
                        // Test tab
                        testHeader = firstLine.split('\t').map(h => h.trim());
                        console.log('Test met tab (', testHeader.length, 'kolommen):', testHeader);
                        
                        if (testHeader.length > 1) {
                            delimiter = '\t';
                            header = testHeader;
                        } else {
                            showStatus('Kan geen juiste delimiter vinden. Probeer een ander CSV formaat.', 'error');
                            return;
                        }
                    }
                }
                
                console.log('Gekozen delimiter:', JSON.stringify(delimiter));
                console.log('Header kolommen:', header);
                
                if (lines.length < 2) {
                    showStatus('CSV heeft alleen een header, geen data regels', 'error');
                    return;
                }
                
                planningHeader = header;
                allPlanningData = [];
                let successCount = 0;
                let skipCount = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) {
                        console.log(`Regel ${i + 1} is leeg, overslaan`);
                        skipCount++;
                        continue;
                    }
                    
                    const row = line.split(delimiter).map(cell => cell.trim());
                    console.log(`Regel ${i + 1} (${row.length} kolommen):`, row);
                    
                    if (row.length !== header.length) {
                        console.log(`Regel ${i + 1} heeft ${row.length} kolommen, verwacht ${header.length} - overslaan`);
                        skipCount++;
                        continue;
                    }
                    
                    const employee = {};
                    header.forEach((col, index) => {
                        employee[col] = row[index];
                    });
                    
                    // Zoek naam in verschillende kolommen
                    const nameField = employee.Naam || employee.naam || employee.Name || employee.name || 
                                    employee.NAAM || employee.Werknemer || employee.werknemer;
                    
                    if (nameField && nameField.trim() && nameField !== '') {
                        allPlanningData.push(employee);
                        console.log(`✓ Employee ${successCount + 1} toegevoegd:`, nameField);
                        successCount++;
                    } else {
                        console.log(`✗ Regel ${i + 1} geen geldige naam gevonden in:`, employee);
                        skipCount++;
                    }
                }
                
                console.log('=== RESULTAAT ===');
                console.log('Succesvol geladen:', successCount);
                console.log('Overgeslagen regels:', skipCount);
                console.log('Totaal data regels:', successCount);
                
                if (allPlanningData.length === 0) {
                    showStatus(`Geen geldige medewerkergegevens gevonden. Controleer of er een naam kolom is. Gevonden kolommen: ${header.join(', ')}`, 'error');
                    return;
                }
                
                // Initieel alle data tonen
                planningData = [...allPlanningData];
                
                // Vul filters
                updatePloegFilter();
                
                displayPlanningTable();
                showStatus(`Planning geladen: ${allPlanningData.length} medewerkers (${skipCount} regels overgeslagen)`, 'success');
                
            } catch (error) {
                console.error('Error parsing CSV:', error);
                showStatus('Fout bij laden CSV: ' + error.message, 'error');
            }
        }
        
        function updatePloegFilter() {
            const ploegFilter = document.getElementById('ploeg-filter');
            const afdelingFilter = document.getElementById('afdeling-filter');
            
            // Update ploeg filter
            const ploegen = [...new Set(allPlanningData.map(emp => emp.Ploeg || emp.ploeg))].filter(Boolean).sort();
            ploegFilter.innerHTML = '<option value="">Alle ploegen</option>';
            ploegen.forEach(ploeg => {
                const option = document.createElement('option');
                option.value = ploeg;
                option.textContent = ploeg;
                ploegFilter.appendChild(option);
            });
            
            // Update afdeling filter
            const afdelingen = [...new Set(allPlanningData.map(emp => emp.Afdeling || emp.afdeling))].filter(Boolean).sort();
            afdelingFilter.innerHTML = '<option value="">Alle afdelingen</option>';
            afdelingen.forEach(afdeling => {
                const option = document.createElement('option');
                option.value = afdeling;
                option.textContent = afdeling;
                afdelingFilter.appendChild(option);
            });
            
            console.log('Beschikbare ploegen:', ploegen);
            console.log('Beschikbare afdelingen:', afdelingen);
        }
        
        function filterPlanning() {
            const selectedPloeg = document.getElementById('ploeg-filter').value;
            const selectedAfdeling = document.getElementById('afdeling-filter').value;
            
            planningData = allPlanningData.filter(emp => {
                let matches = true;
                
                // Filter op ploeg
                if (selectedPloeg && (emp.Ploeg || emp.ploeg) !== selectedPloeg) {
                    matches = false;
                }
                
                // Filter op afdeling
                if (selectedAfdeling && (emp.Afdeling || emp.afdeling) !== selectedAfdeling) {
                    matches = false;
                }
                
                return matches;
            });
            
            console.log(`Gefilterd op ploeg "${selectedPloeg}" en afdeling "${selectedAfdeling}":`, planningData.length, 'medewerkers');
            
            displayPlanningTable();
            updatePlanningInfo();
        }
        
        function updatePlanningInfo() {
            const planningInfo = document.getElementById('planning-info');
            const selectedPloeg = document.getElementById('ploeg-filter').value;
            const selectedAfdeling = document.getElementById('afdeling-filter').value;
            
            let infoText = `${planningData.length} medewerkers`;
            
            const filters = [];
            if (selectedPloeg) filters.push(`ploeg: ${selectedPloeg}`);
            if (selectedAfdeling) filters.push(`afdeling: ${selectedAfdeling}`);
            
            if (filters.length > 0) {
                infoText += ` (${filters.join(', ')})`;
            } else {
                infoText += ' (alle ploegen en afdelingen)';
            }
            
            planningInfo.textContent = infoText;
        }
        
        function displayPlanningTable() {
            const tableHead = document.getElementById('planning-head');
            const tableBody = document.getElementById('planning-body');
            
            // Create header - SKIP de eerste twee kolommen (Ploeg en Afdeling) + voeg werkelijke uren toe
            tableHead.innerHTML = '';
            const headerRow = document.createElement('tr');
            
            planningHeader.forEach((col, index) => {
                // Skip Ploeg (index 0) en Afdeling (index 1)
                if (index === 0 || index === 1) return;
                
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
                
                // Voeg "Uren" kolom toe na elke "plan" kolom (vervang "plan" met "uren")
                if (col.includes('plan')) {
                    const thWerkelijk = document.createElement('th');
                    thWerkelijk.textContent = col.replace('plan', 'uren');
                    thWerkelijk.style.background = '#28a745';
                    thWerkelijk.className = 'werkelijk-header';
                    headerRow.appendChild(thWerkelijk);
                }
            });
            tableHead.appendChild(headerRow);
            
            // Create body - SKIP de eerste twee kolommen + voeg werkelijke uren toe
            tableBody.innerHTML = '';
            planningData.forEach(emp => {
                const row = document.createElement('tr');
                
                planningHeader.forEach((col, index) => {
                    // Skip Ploeg (index 0) en Afdeling (index 1)
                    if (index === 0 || index === 1) return;
                    
                    const cell = document.createElement('td');
                    let cellData = emp[col] || '';
                    
                    // Format tijd cellen
                    if (col.includes('begin') || col.includes('einde')) {
                        cellData = formatTime(cellData);
                        cell.className = 'time-cell';
                    }
                    
                    cell.textContent = cellData;
                    row.appendChild(cell);
                    
                    // Voeg werkelijke uren cel toe na elke geplande uren kolom ("plan")
                    if (col.includes('plan')) {
                        const werkelijkCell = document.createElement('td');
                        
                        // Bepaal welke dag dit is
                        let dag = '';
                        if (col.includes('Ma')) dag = 'maandag';
                        else if (col.includes('Di')) dag = 'dinsdag';
                        else if (col.includes('Wo')) dag = 'woensdag';
                        else if (col.includes('Do')) dag = 'donderdag';
                        else if (col.includes('Vr')) dag = 'vrijdag';
                        
                        // Haal werkelijke uren op voor deze werknemer en dag
                        const werkelijkeUren = getWerkelijkeUren(emp.Naam || emp.naam, dag);
                        
                        werkelijkCell.textContent = werkelijkeUren > 0 ? werkelijkeUren.toFixed(2) : '-';
                        
                        if (werkelijkeUren > 0) {
                            werkelijkCell.className = 'werkelijk-cell';
                        } else {
                            werkelijkCell.className = 'werkelijk-cell empty';
                        }
                        
                        row.appendChild(werkelijkCell);
                    }
                });
                tableBody.appendChild(row);
            });
            
            updatePlanningInfo();
            
            // Show table
            document.getElementById('planning-display').style.display = 'block';
        }
        
        function getWerkelijkeUren(employeeName, dag) {
            if (!registrations || !employeeName || !dag) return 0;
            
            // Get current week Monday
            const today = new Date();
            const currentDay = today.getDay(); // 0 = zondag, 1 = maandag, etc.
            const daysFromMonday = currentDay === 0 ? 6 : currentDay - 1; // Als zondag, dan 6 dagen terug
            const monday = new Date(today);
            monday.setDate(today.getDate() - daysFromMonday);
            
            // Bereken target datum voor de gevraagde dag
            const dagNummers = {
                'maandag': 0,
                'dinsdag': 1, 
                'woensdag': 2,
                'donderdag': 3,
                'vrijdag': 4
            };
            
            const targetDate = new Date(monday);
            targetDate.setDate(monday.getDate() + dagNummers[dag]);
            const targetDateString = targetDate.toISOString().split('T')[0];
            
            console.log(`Zoek werkelijke uren voor ${employeeName} op ${dag} (${targetDateString})`);
            
            // Zoek registraties voor deze werknemer op deze datum
            let totalHours = 0;
            
            registrations.forEach(reg => {
                if (reg.employee === employeeName && reg.date === targetDateString) {
                    console.log(`Gevonden registratie voor ${employeeName}:`, reg);
                    
                    if (reg.hours && typeof reg.hours === 'object') {
                        if (reg.workLineNames && typeof reg.hours === 'object' && !Array.isArray(reg.hours)) {
                            // Nieuwe format (object met werklijnen als keys)
                            Object.entries(reg.hours).forEach(([workLineKey, activities]) => {
                                Object.values(activities).forEach(hours => {
                                    totalHours += parseFloat(hours) || 0;
                                });
                            });
                        } else {
                            // Oude format (direct activities)
                            Object.values(reg.hours).forEach(hours => {
                                totalHours += parseFloat(hours) || 0;
                            });
                        }
                    }
                }
            });
            
            console.log(`Totaal werkelijke uren voor ${employeeName} op ${dag}: ${totalHours}`);
            return totalHours;
        }
        
        // Update de planning tabel wanneer er nieuwe registraties zijn
        function updatePlanningWithNewRegistration() {
            if (planningData.length > 0) {
                console.log('Update planning tabel met nieuwe registratie');
                displayPlanningTable();
            }
        }
        
        function formatTime(timeStr) {
            if (!timeStr || timeStr === '') return '';
            
            const cleanTime = timeStr.toString().replace(/\D/g, '');
            if (cleanTime.length === 3) {
                return cleanTime.charAt(0) + ':' + cleanTime.slice(1);
            } else if (cleanTime.length === 4) {
                return cleanTime.slice(0, 2) + ':' + cleanTime.slice(2);
            }
            return timeStr;
        }
        
        function getTimeClass(timeStr) {
            if (!timeStr) return '';
            
            const time = timeStr.replace(':', '');
            const numTime = parseInt(time);
            
            if (numTime >= 500 && numTime < 1200) {
                return 'early-shift';
            } else if (numTime >= 1200 && numTime < 2000) {
                return 'late-shift';
            } else if (numTime >= 2000 || numTime < 500) {
                return 'night-shift';
            }
            
            return '';
        }
        
        function clearPlanning() {
            planningData = [];
            allPlanningData = [];
            planningHeader = [];
            document.getElementById('planning-display').style.display = 'none';
            document.getElementById('planning-file').value = '';
            document.getElementById('ploeg-filter').innerHTML = '<option value="">Alle ploegen</option>';
            document.getElementById('afdeling-filter').innerHTML = '<option value="">Alle afdelingen</option>';
            showStatus('Personeelsplanning gewist', 'success');
        }

        // Alle originele code hieronder - ongewijzigd
        console.log('=== MSAL CONFIG DEBUG ===');
        
        const REDIRECT_URI = 'https://sh-online.github.io/tijdregistratie/';
        console.log('Using redirect URI:', REDIRECT_URI);
        
        const msalConfig = {
            auth: {
                clientId: 'b6bac90f-29af-4137-a5f0-be4387796f56',
                authority: 'https://login.microsoftonline.com/common',
                redirectUri: REDIRECT_URI
            },
            cache: {
                cacheLocation: 'localStorage',
                storeAuthStateInCookie: false
            }
        };

        console.log('MSAL Config:', JSON.stringify(msalConfig, null, 2));

        const loginRequest = {
            scopes: ['Files.ReadWrite', 'User.Read'],
            redirectUri: REDIRECT_URI
        };

        console.log('Login Request:', JSON.stringify(loginRequest, null, 2));

        let msalInstance;
        let account = null;

        const workLines = {
            'schillijn': {
                name: 'Schillijn',
                activities: ['Produceren', 'Lezen', 'Sous-vide', 'Herbewerken', 'Schoonmaken', 'Overig']
            },
            'inpakken': {
                name: 'Inpakken', 
                activities: ['Produceren', 'Kratten', 'Herbewerken', 'Schoonmaken', 'Overig']
            },
            'sousvide': {
                name: 'Sous-vide',
                activities: ['Gea', 'Overpakken', 'Sleeven', 'Lossnijden', 'Schoonmaken', 'Overig']
            },
            'koelcel': {
                name: 'Koelcel',
                activities: ['Orderpicken', 'Overpakken', 'Voorraadopname', 'Schoonmaken', 'Herbewerken', 'Overig']
            },
            'fusthal': {
                name: 'Fusthal',
                activities: ['Wassen', 'Schoonmaken', 'Overig']
            },
            'puree': {
                name: 'Puree',
                activities: ['Produceren', 'Inpakken', 'Schoonmaken', 'Herbewerken', 'Overig']
            }
        };
        
        let employees = [
            'Agnieszka', 'Aniel', 'Arkadiusz', 'Biniam', 'Biyik', 'Boa', 'Fred', 'Herman', 
            'Kamila', 'Klaas', 'Magda', 'Mustafa', 'Okan', 'Paul', 'Paula', 'Rakesh', 
            'Randhir', 'Rein', 'Roy', 'Samantha', 'Sen', 'Stefan', 'Willem-Jan', 'Wubbe',
            'BDE Agniezka Ircha', 'BDE Amber', 'BDE Ewelina', 'BDE Jessica', 'BDE Krzystof',
            'BDE Monika', 'BDE Patryk', 'BDE Paulina', 'BDE Saraela', 'BDE Uliana',
            'BDE Yaroslav', 'BDE Mahmut', 'BDE Przemyslaw', 'BDE Ewa', 'BDE Man'
        ];
        
        let registrations = [];
        let currentEmployee = null;
        let currentWorkLine = null;
        let multiWorkLineData = {};

        async function initializeMSAL() {
            try {
                console.log('Initializing MSAL...');
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                console.log('MSAL initialized successfully');
                await handleRedirectPromise();
            } catch (error) {
                console.error('MSAL initialization error:', error);
            }
        }

        async function handleRedirectPromise() {
            try {
                console.log('Handling redirect promise...');
                const response = await msalInstance.handleRedirectPromise();
                if (response) {
                    console.log('Login response received:', response);
                    account = response.account;
                    updateUIForSignedInUser();
                } else {
                    console.log('No redirect response, checking existing accounts...');
                    const accounts = msalInstance.getAllAccounts();
                    console.log('Existing accounts:', accounts);
                    if (accounts.length > 0) {
                        account = accounts[0];
                        updateUIForSignedInUser();
                    }
                }
                updateAuthButtons();
            } catch (error) {
                console.error('Error handling redirect:', error);
            }
        }

        async function signInToMicrosoft() {
            try {
                console.log('=== SIGN IN ATTEMPT ===');
                console.log('Using redirect URI:', REDIRECT_URI);
                showStatus('Inloggen bij Microsoft...', 'success');
                
                const loginRequestWithUri = {
                    ...loginRequest,
                    redirectUri: REDIRECT_URI
                };
                
                console.log('Final login request:', JSON.stringify(loginRequestWithUri, null, 2));
                
                await msalInstance.loginRedirect(loginRequestWithUri);
            } catch (error) {
                console.error('Login error:', error);
                showStatus('Fout bij inloggen: ' + error.message, 'error');
            }
        }

        async function signOut() {
            if (account) {
                await msalInstance.logoutRedirect({
                    account: account
                });
            }
        }

        async function getAccessToken() {
            if (!account) {
                throw new Error('Niet ingelogd');
            }

            const request = {
                scopes: loginRequest.scopes,
                account: account
            };

            try {
                const response = await msalInstance.acquireTokenSilent(request);
                return response.accessToken;
            } catch (error) {
                if (error instanceof msal.InteractionRequiredAuthError) {
                    const response = await msalInstance.acquireTokenRedirect(request);
                    return response.accessToken;
                } else {
                    throw error;
                }
            }
        }

        async function uploadCSVToOneDrive(csvContent, fileName) {
            try {
                if (!account) {
                    showStatus('Eerst inloggen bij Microsoft vereist', 'error');
                    return false;
                }

                showStatus('Uploaden naar OneDrive...', 'success');
                
                const accessToken = await getAccessToken();
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                
                const uploadUrl = 'https://graph.microsoft.com/v1.0/me/drive/root/children/' + fileName + '/content';
                
                const response = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'text/csv'
                    },
                    body: blob
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus(`Bestand ${fileName} succesvol geüpload naar OneDrive!`, 'success');
                    return true;
                } else {
                    const error = await response.text();
                    console.error('Upload error:', error);
                    showStatus('Fout bij uploaden: ' + response.statusText, 'error');
                    return false;
                }
                
            } catch (error) {
                console.error('OneDrive upload error:', error);
                showStatus('Fout bij uploaden naar OneDrive: ' + error.message, 'error');
                return false;
            }
        }

        function getUnsentRegistrations() {
            if (!registrations || registrations.length === 0) {
                return [];
            }
            
            const lastSentDate = localStorage.getItem('sousvide_last_sent') || '2000-01-01';
            
            return registrations.filter(reg => 
                reg.date > lastSentDate || 
                (reg.date === lastSentDate && !isRegistrationSent(reg))
            );
        }

        async function checkPendingUploadsOnStartup() {
            console.log('=== STARTUP UPLOAD CHECK ===');
            
            if (!account) {
                console.log('Not logged in, skipping upload check');
                return;
            }
            
            const unsentRegs = getUnsentRegistrations();
            const lastUpload = localStorage.getItem('last_upload_time');
            const lastAppOpen = localStorage.getItem('last_app_open');
            const now = Date.now();
            
            localStorage.setItem('last_app_open', now.toString());
            
            console.log(`Unsent registrations: ${unsentRegs.length}`);
            console.log(`Last upload: ${lastUpload ? new Date(parseInt(lastUpload)).toLocaleString() : 'Never'}`);
            console.log(`Last app open: ${lastAppOpen ? new Date(parseInt(lastAppOpen)).toLocaleString() : 'Never'}`);
            
            const needsUpload = unsentRegs.length > 0 && (
                !lastUpload ||
                !lastAppOpen ||
                (now - parseInt(lastUpload)) > 4 * 60 * 60 * 1000 ||
                unsentRegs.length >= 10
            );
            
            if (needsUpload) {
                console.log(`✅ Upload needed: ${unsentRegs.length} registrations`);
                showStatus(`${unsentRegs.length} registratie(s) uploaden bij opstarten...`, 'success');
                
                const success = await sendDataToOneDrive();
                
                if (success) {
                    localStorage.setItem('last_upload_time', now.toString());
                    showStatus(`✅ ${unsentRegs.length} registratie(s) geüpload bij opstarten!`, 'success');
                } else {
                    showStatus('❌ Upload bij opstarten mislukt - probeer handmatig', 'error');
                }
            } else {
                console.log('No upload needed at startup');
                if (unsentRegs.length > 0) {
                    showStatus(`${unsentRegs.length} registratie(s) wachten op upload`, 'success');
                }
            }
            
            const removedCount = cleanupOldData();
            if (removedCount > 0) {
                console.log(`Cleaned up ${removedCount} old registrations`);
            }
        }

        function performMaintenanceIfNeeded() {
            const lastMaintenance = localStorage.getItem('last_maintenance');
            const now = Date.now();
            const ONE_DAY = 24 * 60 * 60 * 1000;
            
            if (!lastMaintenance || (now - parseInt(lastMaintenance)) > ONE_DAY) {
                console.log('Performing maintenance cleanup...');
                
                const removedCount = cleanupOldData();
                if (removedCount > 0) {
                    console.log(`Maintenance: cleaned up ${removedCount} old registrations`);
                }
                
                localStorage.setItem('last_maintenance', now.toString());
            }
        }

        function updateUIForSignedInUser() {
            if (account) {
                updateSendButton();
                showStatus(`Ingelogd als ${account.name || account.username}`, 'success');
                
                const overlay = document.getElementById('login-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }
        }

        function updateSendButton() {
            const sendButton = document.getElementById('send-data-btn');
            if (sendButton && account) {
                sendButton.textContent = 'Versturen naar OneDrive';
                sendButton.onclick = sendDataToOneDrive;
            }
        }

        function updateAuthButtons() {
            const signInBtn = document.getElementById('sign-in-btn');
            const signOutBtn = document.getElementById('sign-out-btn');
            const userInfo = document.getElementById('user-info');
            
            if (account) {
                if (signInBtn) signInBtn.style.display = 'none';
                if (signOutBtn) signOutBtn.style.display = 'block';
                if (userInfo) userInfo.textContent = `Ingelogd: ${account.name || account.username}`;
            } else {
                if (signInBtn) signInBtn.style.display = 'block';
                if (signOutBtn) signOutBtn.style.display = 'none';
                if (userInfo) userInfo.textContent = '';
            }
        }

        async function sendDataToOneDrive() {
            if (!registrations || registrations.length === 0) {
                showStatus('Geen gegevens om te versturen', 'error');
                return false;
            }
            
            if (!account) {
                showStatus('Eerst inloggen bij Microsoft', 'error');
                await signInToMicrosoft();
                return false;
            }
            
            const lastSentDate = localStorage.getItem('sousvide_last_sent') || '2000-01-01';
            const newRegistrations = registrations.filter(reg => 
                reg.date > lastSentDate || 
                (reg.date === lastSentDate && !isRegistrationSent(reg))
            );
            
            if (newRegistrations.length === 0) {
                const removedCount = cleanupOldData();
                if (removedCount > 0) {
                    showStatus(`Alle gegevens zijn al verzonden. ${removedCount} oude registraties opgeruimd.`, 'success');
                } else {
                    showStatus('Alle gegevens zijn al verzonden', 'error');
                }
                return false;
            }
            
            let csvContent = 'Werknemer;Afdeling;Datum;Tijd;Activiteit;Uren\n';
            
            newRegistrations.forEach(reg => {
                if (reg.hours && typeof reg.hours === 'object') {
                    if (reg.workLineNames && typeof reg.hours === 'object' && !Array.isArray(reg.hours)) {
                        Object.entries(reg.hours).forEach(([workLineKey, activities]) => {
                            const workLineName = workLines[workLineKey] ? workLines[workLineKey].name : workLineKey;
                            Object.entries(activities).forEach(([activity, hours]) => {
                                csvContent += `${reg.employee || 'Onbekend'};${workLineName};${reg.date || 'Onbekend'};${reg.time || 'Onbekend'};${activity};${hours.toString().replace('.', ',')}\n`;
                            });
                        });
                    } else {
                        Object.entries(reg.hours).forEach(([activity, hours]) => {
                            csvContent += `${reg.employee || 'Onbekend'};${reg.workLineName || 'Onbekend'};${reg.date || 'Onbekend'};${reg.time || 'Onbekend'};${activity};${hours.toString().replace('.', ',')}\n`;
                        });
                    }
                }
            });
            
            if (csvContent === 'Werknemer;Afdeling;Datum;Tijd;Activiteit;Uren\n') {
                showStatus('Geen geldige gegevens om te versturen', 'error');
                return false;
            }
            
            const now = new Date();
            const timestamp = `${now.toISOString().split('T')[0]}_${now.toTimeString().slice(0,8).replace(/:/g, '')}`;
            const fileName = `tijdregistratie_versturen_${timestamp}.csv`;
            
            const success = await uploadCSVToOneDrive(csvContent, fileName);
            
            if (success) {
                markRegistrationsAsSent(newRegistrations);
                const today = new Date().toISOString().split('T')[0];
                localStorage.setItem('sousvide_last_sent', today);
                
                const removedCount = cleanupOldData();
                let statusMessage = `${newRegistrations.length} nieuwe registraties naar OneDrive verzonden!`;
                if (removedCount > 0) {
                    statusMessage += ` ${removedCount} oude registraties opgeruimd.`;
                }
                
                showStatus(statusMessage, 'success');
                updateDataPreview();
                return true;
            }
            
            return false;
        }

        function openEmployeeModal() {
            document.getElementById('employee-modal').classList.add('show');
        }

        function closeEmployeeModal() {
            document.getElementById('employee-modal').classList.remove('show');
        }

        window.onclick = function(event) {
            const modal = document.getElementById('employee-modal');
            if (event.target === modal) {
                closeEmployeeModal();
            }
        }

        function toggleDataManagement() {
            const managementEl = document.getElementById('data-management');
            const btnEl = event.target;
            
            if (managementEl.classList.contains('hidden')) {
                managementEl.classList.remove('hidden');
                btnEl.textContent = 'Verberg opties';
            } else {
                managementEl.classList.add('hidden');
                btnEl.textContent = 'Beheer opties';
            }
        }

        function loadEmployees() {
            const savedEmployees = localStorage.getItem('sousvide_employees');
            if (savedEmployees) {
                employees = JSON.parse(savedEmployees);
            }
            updateEmployeeList();
            updateEmployeeGrid();
        }

        function saveEmployees() {
            localStorage.setItem('sousvide_employees', JSON.stringify(employees));
        }

        function updateEmployeeList() {
            const listEl = document.getElementById('employee-list');
            listEl.innerHTML = '';
            
            employees.forEach(employee => {
                const item = document.createElement('div');
                item.className = 'employee-item';
                item.innerHTML = `
                    <span>${employee}</span>
                    <button class="btn-remove" onclick="removeEmployee('${employee}')">Verwijder</button>
                `;
                listEl.appendChild(item);
            });
        }

        function updateEmployeeGrid() {
            const gridEl = document.getElementById('employee-grid');
            gridEl.innerHTML = '';
            
            employees.forEach(employee => {
                const btn = document.createElement('button');
                btn.className = 'employee-btn';
                btn.textContent = employee;
                btn.onclick = () => selectEmployee(employee);
                gridEl.appendChild(btn);
            });
        }

        function addEmployee() {
            const nameInput = document.getElementById('new-employee-name');
            const name = nameInput.value.trim();
            
            if (!name) {
                showStatus('Voer een naam in', 'error');
                return;
            }
            
            if (employees.includes(name)) {
                showStatus('Deze werknemer bestaat al', 'error');
                return;
            }
            
            employees.push(name);
            employees.sort();
            saveEmployees();
            updateEmployeeList();
            updateEmployeeGrid();
            
            nameInput.value = '';
            showStatus(`${name} toegevoegd`, 'success');
        }

        function removeEmployee(name) {
            if (confirm(`Weet je zeker dat je ${name} wilt verwijderen?`)) {
                employees = employees.filter(emp => emp !== name);
                saveEmployees();
                updateEmployeeList();
                updateEmployeeGrid();
                showStatus(`${name} verwijderd`, 'success');
            }
        }

        function selectEmployee(name) {
            document.querySelectorAll('#employee-grid .employee-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            currentEmployee = name;
            currentWorkLine = null;
            multiWorkLineData = {};
            
            document.getElementById('workline-selection').classList.remove('hidden');
            document.getElementById('hours-registration').classList.add('hidden');
            document.getElementById('total-overview').classList.add('hidden');
            
            document.querySelectorAll('#workline-grid .workline-btn').forEach(btn => btn.classList.remove('selected'));
        }

        function selectWorkLine(workLineKey) {
            console.log('selectWorkLine called:', workLineKey);
            
            if (currentWorkLine) {
                saveCurrentWorkLineData();
            }
            
            document.querySelectorAll('#workline-grid .workline-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            currentWorkLine = workLineKey;
            
            const workLine = workLines[workLineKey];
            document.getElementById('hours-registration').classList.remove('hidden');
            document.getElementById('total-overview').classList.remove('hidden');
            
            generateActivitiesTable(workLine.activities);
            loadWorkLineData(workLineKey);
            updateTotalOverview();
        }

        function saveCurrentWorkLineData() {
            if (!currentWorkLine) return;
            
            const activities = workLines[currentWorkLine].activities;
            const workLineData = {};
            
            activities.forEach(activity => {
                const inputId = activity.toLowerCase().replace(/[^a-z0-9]/g, '') + '-hours';
                const input = document.getElementById(inputId);
                if (input && input.value && input.value !== '0') {
                    const hours = parseFloat(input.value);
                    if (hours > 0) {
                        let activityName = activity;
                        if (activity.toLowerCase() === 'overig') {
                            const descriptionInput = document.getElementById(inputId + '-description');
                            if (descriptionInput && descriptionInput.value.trim()) {
                                activityName = `Overig: ${descriptionInput.value.trim()}`;
                            }
                        }
                        workLineData[activityName] = hours;
                    }
                }
            });
            
            if (Object.keys(workLineData).length > 0) {
                multiWorkLineData[currentWorkLine] = workLineData;
            } else {
                delete multiWorkLineData[currentWorkLine];
            }
        }

        function loadWorkLineData(workLineKey) {
            const activities = workLines[workLineKey].activities;
            
            activities.forEach(activity => {
                const inputId = activity.toLowerCase().replace(/[^a-z0-9]/g, '') + '-hours';
                const input = document.getElementById(inputId);
                if (input) {
                    let savedHours = 0;
                    let savedDescription = '';
                    
                    if (multiWorkLineData[workLineKey]) {
                        if (multiWorkLineData[workLineKey][activity]) {
                            savedHours = multiWorkLineData[workLineKey][activity];
                        } else if (activity.toLowerCase() === 'overig') {
                            for (let key in multiWorkLineData[workLineKey]) {
                                if (key.startsWith('Overig:')) {
                                    savedHours = multiWorkLineData[workLineKey][key];
                                    savedDescription = key.substring(7).trim();
                                    break;
                                }
                            }
                        }
                    }
                    
                    input.value = savedHours;
                    
                    if (activity.toLowerCase() === 'overig' && savedDescription) {
                        const descriptionInput = document.getElementById(inputId + '-description');
                        if (descriptionInput) {
                            descriptionInput.value = savedDescription;
                        }
                    }
                }
            });
        }

        function updateTotalOverview() {
            const overviewEl = document.getElementById('total-overview');
            const totalsEl = document.getElementById('workline-totals');
            
            if (currentWorkLine) {
                saveCurrentWorkLineData();
            }
            
            totalsEl.innerHTML = '';
            
            let grandTotal = 0;
            
            Object.entries(multiWorkLineData).forEach(([workLineKey, activities]) => {
                const workLineName = workLines[workLineKey].name;
                const workLineTotal = Object.values(activities).reduce((sum, hours) => sum + hours, 0);
                grandTotal += workLineTotal;
                
                const workLineDiv = document.createElement('div');
                workLineDiv.className = 'workline-total';
                workLineDiv.innerHTML = `
                    <div class="name">${workLineName}</div>
                    <div class="hours">${workLineTotal.toFixed(2)}u</div>
                `;
                totalsEl.appendChild(workLineDiv);
            });
            
            const grandTotalDiv = document.createElement('div');
            grandTotalDiv.className = grandTotal > 8 ? 'grand-total warning' : 'grand-total';
            grandTotalDiv.innerHTML = `
                <div class="name">TOTAAL</div>
                <div class="hours">${grandTotal.toFixed(2)}u</div>
            `;
            totalsEl.appendChild(grandTotalDiv);
            
            if (currentWorkLine) {
                overviewEl.classList.remove('hidden');
            } else {
                overviewEl.classList.add('hidden');
            }
        }

        function generateActivitiesTable(activities) {
            const tbody = document.getElementById('activities-tbody');
            tbody.innerHTML = '';
            
            activities.forEach(activity => {
                const activityId = activity.toLowerCase().replace(/[^a-z0-9]/g, '') + '-hours';
                const row = document.createElement('tr');
                
                const isOverig = activity.toLowerCase() === 'overig';
                const activityDisplay = isOverig ? 
                    `<input type="text" placeholder="Overig, Namelijk:" id="${activityId}-description" 
                     class="overig-description">` : 
                    activity;
                
                row.innerHTML = `
                    <td>${activityDisplay}</td>
                    <td>
                        <div class="hour-controls">
                            <button class="btn-fullday" onclick="setFullDay('${activityId}')">Hele dag</button>
                            <div class="hour-buttons-group">
                                <button class="hour-btn minus" onclick="changeHours('${activityId}', -1)">-1</button>
                                <button class="hour-btn minus" onclick="changeHours('${activityId}', -0.25)">-0,25</button>
                                <input type="number" class="hour-input" id="${activityId}" min="0" max="12" step="0.25" value="0" readonly>
                                <button class="hour-btn plus" onclick="changeHours('${activityId}', 0.25)">+0,25</button>
                                <button class="hour-btn plus" onclick="changeHours('${activityId}', 1)">+1</button>
                                <button class="hour-btn plus" onclick="changeHours('${activityId}', 4)">+4</button>
                            </div>
                        </div>
                    </td>
                    <td>
                        <button class="btn-clear" onclick="clearHours('${activityId}')">Wis</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function changeHours(inputId, change) {
            const input = document.getElementById(inputId);
            const currentValue = parseFloat(input.value) || 0;
            const newValue = Math.max(0, Math.min(12, currentValue + change));
            input.value = newValue;
            updateTotalOverview();
        }

        function setFullDay(inputId) {
            clearAllHours();
            document.getElementById(inputId).value = '7.5';
            updateTotalOverview();
        }

        function clearHours(inputId) {
            document.getElementById(inputId).value = '0';
            updateTotalOverview();
        }

        function clearAllHours() {
            if (!currentWorkLine) return;
            
            const activities = workLines[currentWorkLine].activities;
            activities.forEach(activity => {
                const inputId = activity.toLowerCase().replace(/[^a-z0-9]/g, '') + '-hours';
                const input = document.getElementById(inputId);
                if (input) {
                    input.value = '0';
                }
            });
        }

        async function intelligentUpload() {
            const unsentRegs = getUnsentRegistrations();
            const lastUpload = localStorage.getItem('last_upload_time');
            const now = Date.now();
            
            const shouldUpload = 
                unsentRegs.length >= 10 ||
                (lastUpload && (now - parseInt(lastUpload)) > 4 * 60 * 60 * 1000) ||
                !lastUpload;
            
            if (shouldUpload && unsentRegs.length > 0) {
                showStatus('Uploaden batch naar OneDrive...', 'success');
                const success = await sendDataToOneDrive();
                
                if (success) {
                    localStorage.setItem('last_upload_time', now.toString());
                    showStatus(`${unsentRegs.length} registraties geüpload!`, 'success');
                } else {
                    showStatus('Upload mislukt - probeer later opnieuw', 'error');
                }
            } else {
                showStatus('Registratie opgeslagen', 'success');
            }
        }

        async function saveRegistration() {
            if (!currentEmployee) return;
            
            saveCurrentWorkLineData();
            
            if (Object.keys(multiWorkLineData).length === 0) {
                showStatus('Voer minimaal één activiteit in', 'error');
                return;
            }
            
            let totalHours = 0;
            const workLineNames = [];
            
            Object.entries(multiWorkLineData).forEach(([workLineKey, activities]) => {
                workLineNames.push(workLines[workLineKey].name);
                Object.values(activities).forEach(hours => {
                    totalHours += hours;
                });
            });
            
            const registration = {
                employee: currentEmployee,
                workLineNames: workLineNames,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' }),
                hours: multiWorkLineData,
                total: totalHours
            };
            
            registrations.unshift(registration);
            localStorage.setItem('sousvide_registrations', JSON.stringify(registrations));
            
            if (account) {
                await intelligentUpload();
            } else {
                showStatus('⚠️ Opgeslagen lokaal - login voor automatische upload', 'error');
            }
            
            resetSelection();
            updateDataPreview();
            
            // Update planning tabel als deze zichtbaar is
            updatePlanningWithNewRegistration();
        }

        function resetSelection() {
            currentEmployee = null;
            currentWorkLine = null;
            multiWorkLineData = {};
            document.querySelectorAll('.employee-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('workline-selection').classList.add('hidden');
            document.getElementById('hours-registration').classList.add('hidden');
            document.getElementById('total-overview').classList.add('hidden');
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            
            setTimeout(() => {
                statusEl.textContent = '';
                statusEl.className = '';
            }, 4000);
        }

        function updateDataPreview() {
            const today = new Date().toISOString().split('T')[0];
            
            const departments = ['schillijn', 'inpakken', 'sousvide', 'koelcel', 'fusthal', 'puree'];
            departments.forEach(dept => {
                const preview = document.getElementById(`${dept}-preview`);
                if (preview) preview.textContent = 'Nog geen registraties';
            });
            
            const employeeTotalsPreview = document.getElementById('employee-totals-preview');
            if (employeeTotalsPreview) employeeTotalsPreview.textContent = 'Nog geen registraties';
            
            if (!registrations || registrations.length === 0) {
                return;
            }
            
            const sortedRegistrations = [...registrations].sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                
                const timeA = a.time || '00:00';
                const timeB = b.time || '00:00';
                return timeB.localeCompare(timeA);
            });
            
            const departmentData = {
                schillijn: [],
                inpakken: [],
                sousvide: [],
                koelcel: [],
                fusthal: [],
                puree: []
            };
            
            const employeeTotals = {};
            
            sortedRegistrations.forEach(reg => {
                if (!reg.hours) return;
                
                const isToday = reg.date === today;
                
                if (reg.workLineNames && typeof reg.hours === 'object' && !Array.isArray(reg.hours)) {
                    Object.entries(reg.hours).forEach(([workLineKey, activities]) => {
                        if (departments.includes(workLineKey)) {
                            const workLineName = workLines[workLineKey] ? workLines[workLineKey].name : workLineKey;
                            
                            Object.entries(activities).forEach(([activity, hours]) => {
                                departmentData[workLineKey].push(`${reg.time || 'Onbekend'} ; ${reg.employee} ; ${reg.date || 'Onbekend'} ; ${activity} ; ${hours}u`);
                                
                                if (isToday) {
                                    if (!employeeTotals[reg.employee]) {
                                        employeeTotals[reg.employee] = { totalHours: 0, details: [] };
                                    }
                                    employeeTotals[reg.employee].totalHours += hours;
                                    employeeTotals[reg.employee].details.push(`${workLineName}: ${activity} (${hours}u)`);
                                }
                            });
                        }
                    });
                } else if (reg.workLineName) {
                    const workLineKey = Object.keys(workLines).find(key => workLines[key].name === reg.workLineName);
                    if (workLineKey && departments.includes(workLineKey)) {
                        Object.entries(reg.hours).forEach(([activity, hours]) => {
                            departmentData[workLineKey].push(`${reg.time || 'Onbekend'} ; ${reg.employee} ; ${reg.date || 'Onbekend'} ; ${activity} ; ${hours}u`);
                            
                            if (isToday) {
                                if (!employeeTotals[reg.employee]) {
                                    employeeTotals[reg.employee] = { totalHours: 0, details: [] };
                                }
                                employeeTotals[reg.employee].totalHours += hours;
                                employeeTotals[reg.employee].details.push(`${reg.workLineName}: ${activity} (${hours}u)`);
                            }
                        });
                    }
                }
            });
            
            Object.entries(departmentData).forEach(([deptKey, lines]) => {
                const preview = document.getElementById(`${deptKey}-preview`);
                if (preview) {
                    if (lines.length > 0) {
                        preview.textContent = lines.join('\n');
                    } else {
                        preview.textContent = 'Nog geen registraties';
                    }
                }
            });
            
            if (employeeTotalsPreview) {
                const employeeLines = [];
                Object.entries(employeeTotals)
                    .sort(([a], [b]) => a.localeCompare(b))
                    .forEach(([employee, data]) => {
                        const detailsText = data.details.join(', ');
                        employeeLines.push(`${employee} (${data.totalHours.toFixed(2)}u) - ${detailsText}`);
                    });
                
                if (employeeLines.length > 0) {
                    employeeTotalsPreview.textContent = employeeLines.join('\n');
                } else {
                    employeeTotalsPreview.textContent = 'Nog geen registraties';
                }
            }
        }

        function sendData() {
            if (account) {
                sendDataToOneDrive();
                return;
            }
            
            if (!registrations || registrations.length === 0) {
                showStatus('Geen gegevens om te versturen', 'error');
                return;
            }
            
            const lastSentDate = localStorage.getItem('sousvide_last_sent') || '2000-01-01';
            
            const newRegistrations = registrations.filter(reg => 
                reg.date > lastSentDate || 
                (reg.date === lastSentDate && !isRegistrationSent(reg))
            );
            
            if (newRegistrations.length === 0) {
                const removedCount = cleanupOldData();
                if (removedCount > 0) {
                    showStatus(`Alle gegevens zijn al verzonden. ${removedCount} oude registraties opgeruimd (ouder dan 35 dagen).`, 'success');
                } else {
                    showStatus('Alle gegevens zijn al verzonden', 'error');
                }
                return;
            }
            
            let csvContent = 'Werknemer;Afdeling;Datum;Tijd;Activiteit;Uren\n';
            
            newRegistrations.forEach(reg => {
                if (reg.hours && typeof reg.hours === 'object') {
                    if (reg.workLineNames && typeof reg.hours === 'object' && !Array.isArray(reg.hours)) {
                        Object.entries(reg.hours).forEach(([workLineKey, activities]) => {
                            const workLineName = workLines[workLineKey] ? workLines[workLineKey].name : workLineKey;
                            Object.entries(activities).forEach(([activity, hours]) => {
                                csvContent += `${reg.employee || 'Onbekend'};${workLineName};${reg.date || 'Onbekend'};${reg.time || 'Onbekend'};${activity};${hours.toString().replace('.', ',')}\n`;
                            });
                        });
                    } else {
                        Object.entries(reg.hours).forEach(([activity, hours]) => {
                            csvContent += `${reg.employee || 'Onbekend'};${reg.workLineName || 'Onbekend'};${reg.date || 'Onbekend'};${reg.time || 'Onbekend'};${activity};${hours.toString().replace('.', ',')}\n`;
                        });
                    }
                }
            });
            
            if (csvContent === 'Werknemer;Afdeling;Datum;Tijd;Activiteit;Uren\n') {
                showStatus('Geen geldige gegevens om te versturen', 'error');
                return;
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const now = new Date();
            const timestamp = `${now.toISOString().split('T')[0]}_${now.toTimeString().slice(0,5).replace(':', '')}`;
            link.setAttribute('href', url);
            link.setAttribute('download', `tijdregistratie_versturen_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            markRegistrationsAsSent(newRegistrations);
            
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem('sousvide_last_sent', today);
            
            const removedCount = cleanupOldData();
            
            let statusMessage = `${newRegistrations.length} nieuwe registraties verzonden!`;
            if (removedCount > 0) {
                statusMessage += ` ${removedCount} oude registraties opgeruimd (ouder dan 35 dagen).`;
            }
            
            showStatus(statusMessage, 'success');
            updateDataPreview();
        }
        
        function isRegistrationSent(registration) {
            const sentRegistrations = JSON.parse(localStorage.getItem('sousvide_sent_registrations') || '[]');
            const regId = `${registration.employee}_${registration.date}_${registration.time}`;
            return sentRegistrations.includes(regId);
        }
        
        function markRegistrationsAsSent(registrations) {
            const sentRegistrations = JSON.parse(localStorage.getItem('sousvide_sent_registrations') || '[]');
            
            registrations.forEach(reg => {
                const regId = `${reg.employee}_${reg.date}_${reg.time}`;
                if (!sentRegistrations.includes(regId)) {
                    sentRegistrations.push(regId);
                }
            });
            
            localStorage.setItem('sousvide_sent_registrations', JSON.stringify(sentRegistrations));
        }

        function downloadCSV() {
            if (!registrations || registrations.length === 0) {
                showStatus('Geen data om te downloaden', 'error');
                return;
            }
            
            let csvContent = 'Werknemer;Afdeling;Datum;Activiteit;Uren\n';
            
            registrations.forEach(reg => {
                if (reg.hours && typeof reg.hours === 'object') {
                    if (reg.workLineNames && typeof reg.hours === 'object' && !Array.isArray(reg.hours)) {
                        Object.entries(reg.hours).forEach(([workLineKey, activities]) => {
                            const workLineName = workLines[workLineKey] ? workLines[workLineKey].name : workLineKey;
                            Object.entries(activities).forEach(([activity, hours]) => {
                                csvContent += `${reg.employee || 'Onbekend'};${workLineName};${reg.date || 'Onbekend'};${activity};${hours.toString().replace('.', ',')}\n`;
                            });
                        });
                    } else {
                        Object.entries(reg.hours).forEach(([activity, hours]) => {
                            csvContent += `${reg.employee || 'Onbekend'};${reg.workLineName || 'Onbekend'};${reg.date || 'Onbekend'};${activity};${hours.toString().replace('.', ',')}\n`;
                        });
                    }
                }
            });
            
            if (csvContent === 'Werknemer;Afdeling;Datum;Activiteit;Uren\n') {
                showStatus('Geen geldige data om te downloaden', 'error');
                return;
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const now = new Date();
            const timestamp = `${now.toISOString().split('T')[0]}_${now.toTimeString().slice(0,5).replace(':', '')}`;
            link.setAttribute('href', url);
            link.setAttribute('download', `tijdregistratie_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('CSV gedownload!', 'success');
        }

        function cleanupOldData() {
            const thirtyFiveDaysAgo = new Date();
            thirtyFiveDaysAgo.setDate(thirtyFiveDaysAgo.getDate() - 35);
            const cutoffDate = thirtyFiveDaysAgo.toISOString().split('T')[0];
            
            const originalCount = registrations.length;
            registrations = registrations.filter(reg => reg.date >= cutoffDate);
            const removedCount = originalCount - registrations.length;
            
            if (removedCount > 0) {
                localStorage.setItem('sousvide_registrations', JSON.stringify(registrations));
                updateDataPreview();
                console.log(`${removedCount} oude registraties opgeruimd (ouder dan ${cutoffDate})`);
                return removedCount;
            }
            return 0;
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('sousvide_registrations');
                if (savedData) {
                    registrations = JSON.parse(savedData);
                    if (!Array.isArray(registrations)) {
                        registrations = [];
                    }
                    updateDataPreview();
                }
            } catch (error) {
                console.error('Fout bij laden data:', error);
                registrations = [];
                localStorage.removeItem('sousvide_registrations');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting initialization...');
            
            const nameInput = document.getElementById('new-employee-name');
            if (nameInput) {
                nameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addEmployee();
                    }
                });
            }
            
            loadEmployees();
            loadData();
            
            console.log('Starting MSAL initialization...');
            initializeMSAL().then(() => {
                setTimeout(() => {
                    checkPendingUploadsOnStartup();
                    performMaintenanceIfNeeded();
                }, 2000);
            });
        });
    </script>
</body>
</html>
                                    
